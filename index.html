<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 11 Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            background-color: #000;
            color: white;
        }

        .desktop {
            background: url('https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-position: center;
            transition: filter 0.5s ease;
        }

        .taskbar {
            backdrop-filter: blur(20px) saturate(180%);
            background: rgba(243, 243, 243, 0.7);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 9999;
        }

        .start-menu {
            backdrop-filter: blur(30px) saturate(150%);
            background: rgba(242, 242, 242, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s cubic-bezier(0.1, 0.9, 0.2, 1), opacity 0.2s ease;
            transform: translate(-50%, 100px);
            opacity: 0;
            pointer-events: none;
        }

        .start-menu.active {
            transform: translate(-50%, 0);
            opacity: 1;
            pointer-events: auto;
        }

        .window {
            backdrop-filter: blur(30px) saturate(120%);
            background: rgba(255, 255, 255, 0.85);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.4);
            display: flex;
            flex-direction: column;
            animation: window-open 0.2s ease-out;
        }

        @keyframes window-open {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .window-header {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
        }

        .taskbar-icon {
            transition: all 0.2s ease;
            position: relative;
        }

        .taskbar-icon:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .taskbar-icon:active {
            transform: scale(0.9);
        }

        .taskbar-icon::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: #0067c0;
            border-radius: 2px;
            transition: width 0.2s ease;
        }

        .taskbar-icon.open::after {
            width: 6px;
        }

        .taskbar-icon.focused::after {
            width: 16px;
        }

        .desktop-icon {
            transition: background 0.1s ease;
            position: absolute;
        }

        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .desktop-icon:active {
            background: rgba(255, 255, 255, 0.25);
        }

        .explorer-item.drag-over {
            background: rgba(59, 130, 246, 0.2) !important;
            border-color: rgba(59, 130, 246, 0.5) !important;
        }

        .dragging {
            user-select: none;
            cursor: move !important;
        }

        :root {
            --system-font-size: 14px;
        }

        body {
            font-size: var(--system-font-size);
        }

        /* Dark mode adjustments */
        body.dark .taskbar { background: rgba(32, 32, 32, 0.7); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        body.dark .start-menu { background: rgba(32, 32, 32, 0.85); border: 1px solid rgba(255, 255, 255, 0.1); }
        body.dark .window { background: rgba(32, 32, 32, 0.85); border: 1px solid rgba(255, 255, 255, 0.1); color: white; }
        body.dark .window-header { background: rgba(0, 0, 0, 0.2); }
        body.dark .text-gray-700 { color: #e5e7eb; }
        body.dark .bg-white { background-color: #2d2d2d; }
        body.dark .hover\:bg-gray-200:hover { background-color: #404040; }
        body.dark .dark\:bg-zinc-800 { background-color: #27272a; }
        body.dark .dark\:text-gray-200 { color: #e5e7eb; }
        body.dark .dark\:border-zinc-700 { border-color: #3f3f46; }

        @media (prefers-color-scheme: dark) {
            body:not(.light-theme) {
                /* Default behavior if no theme set */
            }
        }

        .no-blur {
            backdrop-filter: none !important;
            background: rgba(243, 243, 243, 0.95) !important;
        }
        body.dark .no-blur {
            background: rgba(32, 32, 32, 0.95) !important;
        }

        input[type="range"] {
            -webkit-appearance: none;
            height: 4px;
            background: #ddd;
            border-radius: 5px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #0067c0;
            border-radius: 50%;
            cursor: pointer;
        }

        .hidden-window {
            display: none !important;
        }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            inset: 0;
            background: url('https://wallpapercave.com/wp/7FbFtgb.jpg');
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            z-index: 9999;
            padding-bottom: 100px;
            transition: opacity 0.5s ease;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-container {
            text-align: center;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .login-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .login-username {
            color: white;
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 30px;
        }

        .login-input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 16px;
            width: 300px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .login-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .login-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 30px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 300px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-weight: 500;
        }

        .login-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .login-button:active {
            transform: scale(0.98);
        }

        .login-footer {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
        }

        .login-time {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 1;
        }

        .login-time-display {
            font-size: 60px;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .login-date-display {
            font-size: 18px;
            opacity: 0.9;
        }
    </style>
</head>
<body class="h-screen w-screen">
    <!-- Startup Sound -->
    <audio id="startup-sound" src="https://cdn.discordapp.com/attachments/1362855493768315030/1465028301943996617/windows-11-startup-sound-effect.mp3?ex=69779d6e&is=69764bee&hm=8e3d50c481955fd6cc806cac200af2edf6cfd8adcb87382daf3faafa58902850&" style="display: none;" volume="1.0"></audio>

    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-time">
            <div class="login-time-display" id="login-time">12:00</div>
            <div class="login-date-display" id="login-date">Saturday, January 25</div>
        </div>
        <div class="login-footer">
            <div>Â© 2024 Microsoft. All rights reserved.</div>
        </div>
        <div class="login-container">
            <div class="login-avatar">ðŸ‘¤</div>
            <div class="login-username">User</div>
            <input type="password" class="login-input" id="login-password" placeholder="Password" onkeypress="if(event.key==='Enter') loginSubmit()">
            <button class="login-button" onclick="loginSubmit()">Sign in</button>
        </div>
    </div>

    <!-- Brightness Overlay -->
    <div id="brightness-overlay" class="fixed inset-0 bg-black pointer-events-none transition-opacity duration-200" style="opacity: 0; z-index: 10001;"></div>
    
    <!-- Desktop -->
    <div id="desktop" class="desktop h-full w-full relative overflow-hidden" style="display: none;">
        
        <!-- Desktop Icons -->
        <div id="desktop-icons-container" class="absolute inset-0 pointer-events-none" ondragover="handleFileDragOver(event)" ondrop="handleFileDrop(event, 'Desktop')">
            <!-- Dynamically generated -->
        </div>

        <!-- Windows Container -->
        <div id="window-container" class="absolute inset-0 pointer-events-none">
            <!-- Windows will be injected here -->
        </div>

        <!-- Start Menu -->
        <div id="start-menu" class="start-menu fixed bottom-14 left-1/2 w-[540px] max-w-[95vw] h-[600px] max-h-[80vh] p-8 flex flex-col pointer-events-none">
            <div class="relative mb-8">
                <input id="start-search-input" type="text" placeholder="Search for apps, settings, and documents" class="w-full px-4 py-2 rounded-full bg-white dark:bg-zinc-800 border-b-2 border-blue-500 focus:outline-none text-sm" autocomplete="off">
                <svg class="absolute right-4 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </div>

            <div id="start-default-view" class="flex-1 overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xs font-semibold dark:text-gray-300">Pinned</span>
                    <button class="text-[11px] bg-white dark:bg-zinc-700 px-2 py-0.5 rounded border border-gray-200 dark:border-zinc-600">All apps ></button>
                </div>

                <div class="grid grid-cols-6 gap-y-6">
                    <!-- Start Menu Apps -->
                    <div class="flex flex-col items-center cursor-pointer hover:bg-white/10 p-2 rounded" onclick="openApp('edge')">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/9/98/Microsoft_Edge_logo_%282019%29.svg" class="w-8 h-8">
                        <span class="text-[11px] mt-1 text-center dark:text-gray-200">Edge</span>
                    </div>
                    <div class="flex flex-col items-center cursor-pointer hover:bg-white/10 p-2 rounded" onclick="openApp('settings')">
                        <img src="https://img.icons8.com/color/48/settings--v1.png" class="w-8 h-8">
                        <span class="text-[11px] mt-1 text-center dark:text-gray-200">Settings</span>
                    </div>
                    <div class="flex flex-col items-center cursor-pointer hover:bg-white/10 p-2 rounded" onclick="openApp('calculator')">
                        <img src="https://img.icons8.com/color/48/calculator.png" class="w-8 h-8">
                        <span class="text-[11px] mt-1 text-center dark:text-gray-200">Calculator</span>
                    </div>
                    <div class="flex flex-col items-center cursor-pointer hover:bg-white/10 p-2 rounded" onclick="openApp('notepad')">
                        <img src="https://img.icons8.com/color/48/notepad.png" class="w-8 h-8">
                        <span class="text-[11px] mt-1 text-center dark:text-gray-200">Notepad</span>
                    </div>
                    <div class="flex flex-col items-center cursor-pointer hover:bg-white/10 p-2 rounded" onclick="openApp('this-pc')">
                        <img src="https://img.icons8.com/color/48/folder-invoices--v1.png" class="w-8 h-8">
                        <span class="text-[11px] mt-1 text-center dark:text-gray-200">Explorer</span>
                    </div>
                    <div class="flex flex-col items-center cursor-pointer hover:bg-white/10 p-2 rounded" onclick="openApp('temu-spotify')">
                        <img src="https://img.icons8.com/color/48/spotify.png" class="w-8 h-8">
                        <span class="text-[11px] mt-1 text-center dark:text-gray-200">Spotify</span>
                    </div>
                    <div class="flex flex-col items-center cursor-pointer hover:bg-white/10 p-2 rounded" onclick="openApp('clock')">
                        <img src="https://img.icons8.com/color/48/clock--v1.png" class="w-8 h-8">
                        <span class="text-[11px] mt-1 text-center dark:text-gray-200">Clock</span>
                    </div>
                    <div class="flex flex-col items-center cursor-pointer hover:bg-white/10 p-2 rounded" onclick="openApp('temutube')">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSmHCqoQDr_Et05Q3esQGuyWgJW7VESNFij9w&s" class="w-8 h-8">
                        <span class="text-[11px] mt-1 text-center dark:text-gray-200">Temutube</span>
                    </div>
                    <div class="flex flex-col items-center cursor-pointer hover:bg-white/10 p-2 rounded" onclick="alert('Store is coming soon!')">
                        <img src="https://img.icons8.com/color/48/microsoft-store.png" class="w-8 h-8">
                        <span class="text-[11px] mt-1 text-center dark:text-gray-200">Store</span>
                    </div>
                </div>
            </div>

            <div id="start-search-view" class="flex-1 overflow-y-auto hidden">
                <div class="mb-4">
                    <span class="text-xs font-semibold dark:text-gray-300">Search Results</span>
                </div>
                <div id="search-results-list" class="flex flex-col gap-1">
                    <!-- Search results here -->
                </div>
            </div>

            <div class="mt-auto pt-4 border-t border-gray-200 dark:border-zinc-700 flex items-center justify-between">
                <div class="flex items-center gap-3 hover:bg-white/10 p-2 rounded cursor-pointer">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-xs">U</div>
                    <span class="text-xs font-semibold dark:text-gray-200">User</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="p-2 hover:bg-white/10 rounded cursor-pointer" onclick="openApp('clock')">
                        <img src="https://img.icons8.com/ios-filled/24/null/clock.png" class="w-5 h-5 dark:invert">
                    </div>
                    <div class="p-2 hover:bg-white/10 rounded cursor-pointer" onclick="location.reload()">
                        <img src="https://img.icons8.com/ios-filled/24/null/shutdown.png" class="w-5 h-5 dark:invert">
                    </div>
                </div>
            </div>
        </div>

        <!-- Taskbar -->
        <div class="taskbar fixed bottom-0 left-0 w-full h-12 flex items-center justify-between px-3">
            <div class="flex-1 flex items-center gap-1 overflow-hidden">
                <!-- Weather Widget -->
                <div id="weather-widget" class="flex items-center px-2 py-1 rounded hover:bg-white/20 cursor-pointer" onclick="openApp('weather')">
                    <img id="weather-taskbar-icon" src="https://img.icons8.com/color/48/cloud.png" class="w-5 h-5 mr-2">
                    <div class="text-[11px] dark:text-gray-200">
                        <div id="weather-taskbar-temp" class="font-bold">22Â°C</div>
                        <div id="weather-taskbar-desc" class="opacity-70">Cloudy</div>
                    </div>
                </div>
            </div>

            <!-- Taskbar Icons -->
            <div class="flex items-center gap-1">
                <div id="start-btn" class="taskbar-icon p-2 rounded">
                    <img src="https://img.icons8.com/color/48/windows-11.png" class="w-6 h-6">
                </div>
                <div id="search-btn" class="taskbar-icon p-2 rounded">
                    <img src="https://img.icons8.com/color/48/search--v1.png" class="w-6 h-6">
                </div>
                <div class="taskbar-icon p-2 rounded" onclick="openApp('edge')" data-app-id="edge" oncontextmenu="showContextMenu(event, 'edge')">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/9/98/Microsoft_Edge_logo_%282019%29.svg" class="w-6 h-6">
                </div>
                <div class="taskbar-icon p-2 rounded" onclick="openApp('this-pc')" data-app-id="this-pc" oncontextmenu="showContextMenu(event, 'this-pc')">
                    <img src="https://img.icons8.com/color/48/folder-invoices--v1.png" class="w-6 h-6">
                </div>
                <div class="taskbar-icon p-2 rounded" onclick="openApp('settings')" data-app-id="settings" oncontextmenu="showContextMenu(event, 'settings')">
                    <img src="https://img.icons8.com/color/48/settings--v1.png" class="w-6 h-6">
                </div>
                <div class="taskbar-icon p-2 rounded" onclick="openApp('temu-spotify')" data-app-id="temu-spotify" oncontextmenu="showContextMenu(event, 'temu-spotify')">
                    <img src="https://img.icons8.com/color/48/spotify.png" class="w-6 h-6">
                </div>
            </div>

            <!-- System Tray -->
            <div class="flex-1 flex items-center justify-end gap-2 h-full">
                <div class="flex items-center gap-2 hover:bg-white/20 h-full px-2 rounded cursor-pointer" onclick="showActionCenter()">
                    <img src="https://img.icons8.com/ios-glyphs/30/null/notification.png" class="w-4 h-4 dark:invert opacity-60">
                </div>
                <div class="flex items-center gap-2 hover:bg-white/20 h-full px-2 rounded cursor-pointer" onclick="toggleWifiPanel()">
                    <img id="taskbar-wifi-icon" src="https://upload.wikimedia.org/wikipedia/commons/a/ae/WiFi_Logo.svg" class="w-4 h-4 dark:invert" alt="wifi.png" title="wifi.png">
                </div>
                <div class="flex items-center gap-2 hover:bg-white/20 h-full px-2 rounded cursor-pointer" onclick="toggleVolumeControl()">
                    <img src="https://img.icons8.com/ios-glyphs/30/null/high-volume.png" class="w-4 h-4 dark:invert">
                </div>
                <div class="flex items-center gap-2 hover:bg-white/20 h-full px-2 rounded cursor-pointer" onclick="showBatteryStatus()">
                    <img src="https://img.icons8.com/ios-glyphs/30/null/full-battery.png" class="w-4 h-4 dark:invert">
                </div>
            </div>
                <div class="text-right text-[11px] dark:text-gray-200 hover:bg-white/20 h-full px-2 flex flex-col justify-center rounded cursor-pointer" onclick="openApp('clock')">
                    <div id="clock-time">12:00 PM</div>
                    <div id="clock-date">01/01/2024</div>
                </div>
                <div class="w-1.5 h-full border-l border-gray-400/30 hover:bg-white/20 cursor-pointer"></div>
            </div>
        </div>

        <!-- Context Menu -->
        <div id="taskbar-context-menu" class="hidden fixed bg-white dark:bg-zinc-800 border border-gray-300 dark:border-zinc-700 rounded shadow-lg z-50 text-sm" style="min-width: 150px;">
            <div class="py-1">
                <div id="context-pin-btn" class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer" onclick="handleContextMenuAction('pin')">
                    Pin to taskbar
                </div>
                <div id="context-unpin-btn" class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer hidden" onclick="handleContextMenuAction('unpin')">
                    Unpin from taskbar
                </div>
                <div class="border-t border-gray-200 dark:border-zinc-700"></div>
                <div id="context-close-btn" class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer" onclick="handleContextMenuAction('close')">
                    Close
                </div>
            </div>
        </div>

        <!-- Desktop Context Menu -->
        <div id="desktop-context-menu" class="hidden fixed bg-white dark:bg-zinc-800 border border-gray-300 dark:border-zinc-700 rounded shadow-lg z-50 text-sm" style="min-width: 150px;">
            <div class="py-1">
                <div class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer" onclick="refreshDesktop()">
                    Refresh
                </div>
                <div class="border-t border-gray-200 dark:border-zinc-700"></div>
                <div class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer" onclick="openApp('settings')">
                    Display settings
                </div>
                <div class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer" onclick="toggleDarkMode()">
                    Toggle dark mode
                </div>
            </div>
        </div>
    </div>

    <script>
        // Login Screen Functions
        function loginSubmit() {
            const password = document.getElementById('login-password').value;
            const loginScreen = document.getElementById('login-screen');
            const desktop = document.getElementById('desktop');
            
            if (password.length > 0) {
                // Play startup sound
                const startupSound = document.getElementById('startup-sound');
                startupSound.volume = 1.0;
                startupSound.currentTime = 0;
                startupSound.play().catch(() => {
                    // Sound failed to play, continue anyway
                });

                loginScreen.style.opacity = '0';
                setTimeout(() => {
                    loginScreen.classList.add('hidden');
                    desktop.style.display = 'block';
                    desktop.style.animation = 'fadeIn 0.5s ease';
                }, 500);
            }
        }

        function updateLoginTime() {
            const now = new Date();
            document.getElementById('login-time').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('login-date').textContent = now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
        }

        // Update login time every minute
        setInterval(updateLoginTime, 60000);
        updateLoginTime();

        // Add fadeIn animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        `;
        document.head.appendChild(style);

        // System State
        const state = {
            zIndex: 100,
            activeApps: {},
            pinnedApps: ['edge', 'this-pc', 'settings', 'temu-spotify'],
            brightness: 100,
            volume: 50,
            isDarkMode: window.matchMedia('(prefers-color-scheme: dark)').matches,
            theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light',
            fontSize: 14,
            transparency: true,
            wallpaper: 'https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80',
            wifi: {
                enabled: true,
                connectedTo: 'Home_Wi-Fi',
                networks: [
                    { name: 'Home_Wi-Fi', secure: true, signal: 4 },
                    { name: 'Coffee_Shop_Guest', secure: false, signal: 3 },
                    { name: 'Public_Free_Wifi', secure: false, signal: 2 },
                    { name: 'Hidden_Network', secure: true, signal: 1 }
                ]
            },
            battery: {
                level: 85,
                charging: false
            },
            explorer: {
                path: ['This PC'],
                history: [['This PC']],
                historyIndex: 0
            }
        };

        const fileSystem = {
            'This PC': {
                type: 'root',
                children: ['Documents', 'Downloads', 'Pictures', 'Music', 'Videos', 'C: Drive']
            },
            'Documents': {
                type: 'folder',
                children: ['Work', 'Projects', 'secret.txt']
            },
            'Work': { type: 'folder', children: [] },
            'Projects': { type: 'folder', children: [] },
            'secret.txt': { type: 'file', content: 'This is a secret note found in the explorer!' },
            'Downloads': { type: 'folder', children: ['setup.exe'] },
            'setup.exe': { type: 'file', content: 'Installer file (Simulated)' },
            'Pictures': { type: 'folder', children: ['vacation.jpg', 'me.png'] },
            'vacation.jpg': { type: 'file', content: 'Image data...' },
            'me.png': { type: 'file', content: 'Image data...' },
            'Music': { type: 'folder', children: [] },
            'Videos': { type: 'folder', children: [] },
            'C: Drive': {
                type: 'folder',
                children: ['Windows', 'Users', 'Program Files']
            },
            'Windows': { type: 'folder', children: ['System32', 'Web'] },
            'System32': { type: 'folder', children: ['drivers', 'config'] },
            'Users': { type: 'folder', children: ['User'] },
            'User': { type: 'folder', children: ['Desktop', 'Documents', 'Downloads'] },
            'Desktop': { type: 'folder', children: ['This PC', 'Recycle Bin', 'Browser'] },
            'Program Files': { type: 'folder', children: ['Edge', 'Calculator'] },
            'Recycle Bin': { type: 'folder', children: [] },
            'Browser': { type: 'app', id: 'edge' }
        };

        const appIcons = {
            'edge': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Microsoft_Edge_logo_%282019%29.svg',
            'settings': 'https://img.icons8.com/color/48/settings--v1.png',
            'calculator': 'https://img.icons8.com/color/48/calculator.png',
            'notepad': 'https://img.icons8.com/color/48/notepad.png',
            'this-pc': 'https://img.icons8.com/color/48/folder-invoices--v1.png',
            'temu-spotify': 'https://img.icons8.com/color/48/spotify.png',
            'clock': 'https://img.icons8.com/color/48/clock--v1.png',
            'weather': 'https://img.icons8.com/color/48/partly-cloudy-day.png',
            'recycle-bin': 'https://img.icons8.com/color/48/trash--v1.png',
            'uranidiot': 'https://upload.wikimedia.org/wikipedia/commons/5/5c/You_Are_An_Idiot_screen.gif',
            'temutube': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSmHCqoQDr_Et05Q3esQGuyWgJW7VESNFij9w&s'
        };

        // DOM Elements
        const clockTime = document.getElementById('clock-time');
        const clockDate = document.getElementById('clock-date');
        const startBtn = document.getElementById('start-btn');
        const startMenu = document.getElementById('start-menu');
        const windowContainer = document.getElementById('window-container');
        const brightnessOverlay = document.getElementById('brightness-overlay');

        // Clock
        function updateClock() {
            const now = new Date();
            clockTime.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            clockDate.textContent = now.toLocaleDateString([], { month: '2-digit', day: '2-digit', year: 'numeric' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Weather Simulation
        const weatherStates = [
            { temp: 22, desc: 'Cloudy', icon: 'https://img.icons8.com/color/48/cloud.png' },
            { temp: 25, desc: 'Sunny', icon: 'https://img.icons8.com/color/48/sun.png' },
            { temp: 19, desc: 'Rainy', icon: 'https://img.icons8.com/color/48/rain.png' },
            { temp: 21, desc: 'Partly Cloudy', icon: 'https://img.icons8.com/color/48/partly-cloudy-day.png' },
            { temp: 18, desc: 'Stormy', icon: 'https://img.icons8.com/color/48/storm.png' }
        ];

        function updateWeather() {
            const state = weatherStates[Math.floor(Math.random() * weatherStates.length)];
            document.getElementById('weather-taskbar-temp').innerText = state.temp + 'Â°C';
            document.getElementById('weather-taskbar-desc').innerText = state.desc;
            document.getElementById('weather-taskbar-icon').src = state.icon;
            
            // Sync with weather app if open
            const weatherWin = document.getElementById('window-weather');
            if (weatherWin) {
                weatherWin.querySelector('#weather-app-temp').innerText = state.temp + 'Â°C';
                weatherWin.querySelector('#weather-app-desc').innerText = state.desc;
                weatherWin.querySelector('#weather-app-hero-icon').src = state.icon.replace('48', '96');
            }
        }
        setInterval(updateWeather, 30000); // Update every 30 seconds
        updateWeather();

        // Start Menu Toggle
        const searchBtn = document.getElementById('search-btn');
        const startSearchInput = document.getElementById('start-search-input');
        const startDefaultView = document.getElementById('start-default-view');
        const startSearchView = document.getElementById('start-search-view');
        const searchResultsList = document.getElementById('search-results-list');

        function toggleStartMenu(open = null, focusSearch = false) {
            if (open === true) startMenu.classList.add('active');
            else if (open === false) startMenu.classList.remove('active');
            else startMenu.classList.toggle('active');

            if (startMenu.classList.contains('active')) {
                if (focusSearch) startSearchInput.focus();
            } else {
                startSearchInput.value = '';
                updateSearch('');
            }
        }

        startBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleStartMenu();
        });

        searchBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleStartMenu(true, true);
        });

        // Desktop Context Menu
        const desktopElement = document.getElementById('desktop');
        desktopElement.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const menu = document.getElementById('desktop-context-menu');
            menu.classList.remove('hidden');
            menu.style.left = e.pageX + 'px';
            menu.style.top = (e.pageY - 10) + 'px';
        });

        document.addEventListener('click', (e) => {
            const desktopMenu = document.getElementById('desktop-context-menu');
            const taskbarMenu = document.getElementById('taskbar-context-menu');
            
            if (desktopMenu && !desktopMenu.contains(e.target)) {
                desktopMenu.classList.add('hidden');
            }
            if (taskbarMenu && !taskbarMenu.contains(e.target)) {
                taskbarMenu.classList.add('hidden');
            }
        });

        function refreshDesktop() {
            showNotification('Desktop', 'Desktop refreshed!');
            document.getElementById('desktop-context-menu').classList.add('hidden');
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            document.getElementById('desktop-context-menu').classList.add('hidden');
        }

        startSearchInput.addEventListener('input', (e) => {
            updateSearch(e.target.value);
        });

        function updateSearch(query) {
            query = query.toLowerCase().trim();
            if (!query) {
                startDefaultView.classList.remove('hidden');
                startSearchView.classList.add('hidden');
                return;
            }

            startDefaultView.classList.add('hidden');
            startSearchView.classList.remove('hidden');
            searchResultsList.innerHTML = '';

            const results = [];

            // Search Apps
            Object.entries(apps).forEach(([id, app]) => {
                if (app.title.toLowerCase().includes(query)) {
                    results.push({ type: 'app', id, title: app.title, icon: app.icon });
                }
            });

            // Search Files
            Object.entries(fileSystem).forEach(([name, data]) => {
                if (name.toLowerCase().includes(query)) {
                    const isFile = data.type === 'file';
                    const icon = isFile ? 
                        (name.endsWith('.txt') ? 'https://img.icons8.com/color/48/notepad.png' : 'https://img.icons8.com/color/48/file.png') : 
                        'https://img.icons8.com/color/48/folder-invoices--v1.png';
                    results.push({ type: isFile ? 'file' : 'folder', name, title: name, icon });
                }
            });

            if (results.length === 0) {
                searchResultsList.innerHTML = `
                    <div class="p-4 text-center text-xs opacity-50 italic">No local results found.</div>
                `;
            } else {
                results.forEach(res => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-2 hover:bg-white/10 rounded cursor-pointer';
                    div.onclick = () => {
                        if (res.type === 'app') openApp(res.id);
                        else if (res.type === 'file') openFile(res.name);
                        else if (res.type === 'folder') navigateExplorerTo(res.name);
                        toggleStartMenu(false);
                    };
                    div.innerHTML = `
                        <img src="${res.icon}" class="w-6 h-6">
                        <div class="flex flex-col">
                            <span class="text-[11px] font-semibold dark:text-gray-200">${res.title}</span>
                            <span class="text-[9px] opacity-60 dark:text-gray-400 capitalize">${res.type}</span>
                        </div>
                    `;
                    searchResultsList.appendChild(div);
                });
            }

            // Always offer Web Search
            const webSearchDiv = document.createElement('div');
            webSearchDiv.className = 'flex items-center gap-3 p-2 hover:bg-white/10 rounded cursor-pointer border-t border-gray-200 dark:border-zinc-700 mt-2 pt-3';
            webSearchDiv.onclick = () => {
                openApp('edge');
                setTimeout(() => {
                    const edgeWin = document.getElementById('window-edge');
                    if (edgeWin) {
                        const url = 'https://www.google.com/search?q=' + encodeURIComponent(query);
                        window.open(url, '_blank');
                    }
                }, 100);
                toggleStartMenu(false);
            };
            webSearchDiv.innerHTML = `
                <img src="https://img.icons8.com/color/48/google-logo.png" class="w-6 h-6">
                <div class="flex flex-col">
                    <span class="text-[11px] font-semibold dark:text-gray-200">Search the web for "${query}"</span>
                    <span class="text-[9px] opacity-60 dark:text-gray-400">Open in Edge</span>
                </div>
            `;
            searchResultsList.appendChild(webSearchDiv);
        }

        // App Definitions
        const apps = {
            'clock': {
                title: 'Clock',
                icon: 'https://img.icons8.com/color/48/clock--v1.png',
                width: 500,
                height: 450,
                content: `
                    <div class="h-full flex flex-col bg-[#f3f3f3] dark:bg-zinc-900 overflow-hidden">
                        <div class="flex border-b border-gray-200 dark:border-zinc-800 bg-white dark:bg-zinc-800/50">
                            <button class="flex-1 py-2 text-xs font-semibold border-b-2 border-blue-500 text-blue-600" onclick="switchClockTab(this, 'stopwatch')">Stopwatch</button>
                            <button class="flex-1 py-2 text-xs font-semibold text-gray-500" onclick="switchClockTab(this, 'timer')">Timer</button>
                            <button class="flex-1 py-2 text-xs font-semibold text-gray-500" onclick="switchClockTab(this, 'world')">World Clock</button>
                        </div>
                        <div class="flex-1 p-8 overflow-auto">
                            <!-- Stopwatch -->
                            <div id="clock-stopwatch" class="flex flex-col items-center justify-center h-full">
                                <div id="stopwatch-display" class="text-6xl font-light mb-8 font-mono">00:00.00</div>
                                <div class="flex gap-4">
                                    <button id="stopwatch-start" class="w-24 py-2 bg-blue-600 text-white rounded-full font-bold hover:bg-blue-700">Start</button>
                                    <button id="stopwatch-reset" class="w-24 py-2 bg-gray-200 dark:bg-zinc-700 rounded-full font-bold">Reset</button>
                                </div>
                            </div>
                            <!-- Timer -->
                            <div id="clock-timer" class="hidden flex-col items-center justify-center h-full">
                                <div class="relative w-48 h-48 flex items-center justify-center mb-8">
                                    <svg class="w-full h-full transform -rotate-90">
                                        <circle cx="96" cy="96" r="88" stroke="currentColor" stroke-width="4" fill="transparent" class="text-gray-200 dark:text-zinc-800" />
                                        <circle id="timer-progress" cx="96" cy="96" r="88" stroke="currentColor" stroke-width="4" fill="transparent" stroke-dasharray="553" stroke-dashoffset="0" class="text-blue-600 transition-all duration-1000" />
                                    </svg>
                                    <div id="timer-display" class="absolute text-4xl font-light font-mono">05:00</div>
                                </div>
                                <div class="flex gap-2 mb-6">
                                    <button onclick="setTimer(60)" class="px-3 py-1 bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 rounded text-xs">1m</button>
                                    <button onclick="setTimer(300)" class="px-3 py-1 bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 rounded text-xs">5m</button>
                                    <button onclick="setTimer(600)" class="px-3 py-1 bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 rounded text-xs">10m</button>
                                </div>
                                <div class="flex gap-4">
                                    <button id="timer-start" class="w-24 py-2 bg-blue-600 text-white rounded-full font-bold hover:bg-blue-700">Start</button>
                                    <button id="timer-reset" class="w-24 py-2 bg-gray-200 dark:bg-zinc-700 rounded-full font-bold">Reset</button>
                                </div>
                            </div>
                            <!-- World Clock -->
                            <div id="clock-world" class="hidden flex flex-col gap-4">
                                ${[
                                    { city: 'London', offset: 0 },
                                    { city: 'New York', offset: -5 },
                                    { city: 'Tokyo', offset: 9 },
                                    { city: 'Sydney', offset: 11 }
                                ].map(place => `
                                    <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg flex justify-between items-center shadow-sm">
                                        <div>
                                            <div class="text-sm font-bold">${place.city}</div>
                                            <div class="text-[10px] opacity-60">GMT ${place.offset >= 0 ? '+' : ''}${place.offset}</div>
                                        </div>
                                        <div class="text-xl font-light font-mono" data-offset="${place.offset}">00:00 AM</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `,
                onMount: (win) => {
                    // Stopwatch Logic
                    let swInterval;
                    let swTime = 0; // ms
                    const swDisplay = win.querySelector('#stopwatch-display');
                    const swStart = win.querySelector('#stopwatch-start');
                    const swReset = win.querySelector('#stopwatch-reset');

                    swStart.onclick = () => {
                        if (swInterval) {
                            clearInterval(swInterval);
                            swInterval = null;
                            swStart.innerText = 'Start';
                            swStart.classList.replace('bg-orange-500', 'bg-blue-600');
                        } else {
                            const startTime = Date.now() - swTime;
                            swInterval = setInterval(() => {
                                swTime = Date.now() - startTime;
                                const ms = Math.floor((swTime % 1000) / 10);
                                const sec = Math.floor((swTime / 1000) % 60);
                                const min = Math.floor(swTime / 60000);
                                swDisplay.innerText = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
                            }, 10);
                            swStart.innerText = 'Stop';
                            swStart.classList.replace('bg-blue-600', 'bg-orange-500');
                        }
                    };

                    swReset.onclick = () => {
                        clearInterval(swInterval);
                        swInterval = null;
                        swTime = 0;
                        swDisplay.innerText = '00:00.00';
                        swStart.innerText = 'Start';
                        swStart.classList.replace('bg-orange-500', 'bg-blue-600');
                    };

                    // Timer Logic
                    let tInterval;
                    let tRemaining = 300; // 5 mins default
                    let tTotal = 300;
                    const tDisplay = win.querySelector('#timer-display');
                    const tProgress = win.querySelector('#timer-progress');
                    const tStart = win.querySelector('#timer-start');
                    const tReset = win.querySelector('#timer-reset');

                    window.setTimer = (sec) => {
                        tRemaining = sec;
                        tTotal = sec;
                        updateTimerUI();
                    };

                    const updateTimerUI = () => {
                        const m = Math.floor(tRemaining / 60);
                        const s = tRemaining % 60;
                        tDisplay.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                        const offset = 553 - (tRemaining / tTotal) * 553;
                        tProgress.style.strokeDashoffset = offset;
                    };

                    tStart.onclick = () => {
                        if (tInterval) {
                            clearInterval(tInterval);
                            tInterval = null;
                            tStart.innerText = 'Start';
                        } else {
                            tInterval = setInterval(() => {
                                tRemaining--;
                                if (tRemaining <= 0) {
                                    clearInterval(tInterval);
                                    tInterval = null;
                                    showNotification('Timer', 'Time is up!');
                                    tRemaining = 0;
                                }
                                updateTimerUI();
                            }, 1000);
                            tStart.innerText = 'Pause';
                        }
                    };

                    tReset.onclick = () => {
                        clearInterval(tInterval);
                        tInterval = null;
                        tRemaining = tTotal;
                        updateTimerUI();
                        tStart.innerText = 'Start';
                    };

                    // World Clock Logic
                    const updateWorldClock = () => {
                        const now = new Date();
                        win.querySelectorAll('#clock-world [data-offset]').forEach(el => {
                            const offset = parseInt(el.dataset.offset);
                            const time = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (offset * 3600000));
                            el.innerText = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        });
                    };
                    setInterval(updateWorldClock, 1000);
                    updateWorldClock();

                    window.switchClockTab = (btn, tabId) => {
                        win.querySelectorAll('.flex.border-b button').forEach(b => {
                            b.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600');
                            b.classList.add('text-gray-500');
                        });
                        btn.classList.add('border-b-2', 'border-blue-500', 'text-blue-600');
                        btn.classList.remove('text-gray-500');

                        win.querySelector('#clock-stopwatch').classList.add('hidden');
                        win.querySelector('#clock-timer').classList.add('hidden');
                        win.querySelector('#clock-world').classList.add('hidden');
                        win.querySelector('#clock-' + tabId).classList.remove('hidden');
                        if (tabId === 'timer' || tabId === 'stopwatch') win.querySelector('#clock-' + tabId).classList.add('flex');
                    };
                }
            },
            'temu-spotify': {
                title: 'Spotify',
                icon: 'https://img.icons8.com/color/48/spotify.png',
                width: 900,
                height: 650,
                content: `
                    <div class="h-full flex flex-col bg-[#121212] text-white font-sans overflow-hidden spotify-app">
                        <div class="flex flex-1 overflow-hidden">
                            <!-- Sidebar -->
                            <div class="w-60 bg-black p-6 flex flex-col gap-6">
                                <div class="flex items-center gap-4 opacity-70 hover:opacity-100 cursor-pointer transition-opacity">
                                    <img src="https://img.icons8.com/material-rounded/24/ffffff/home.png" class="w-6 h-6">
                                    <span class="text-sm font-bold">Home</span>
                                </div>
                                <div class="flex items-center gap-4 opacity-70 hover:opacity-100 cursor-pointer transition-opacity">
                                    <img src="https://img.icons8.com/material-rounded/24/ffffff/search.png" class="w-6 h-6">
                                    <span class="text-sm font-bold">Search</span>
                                </div>
                                <div class="flex items-center gap-4 opacity-70 hover:opacity-100 cursor-pointer transition-opacity">
                                    <img src="https://img.icons8.com/material-rounded/24/ffffff/library.png" class="w-6 h-6">
                                    <span class="text-sm font-bold">Your Library</span>
                                </div>
                                <div class="mt-8 flex flex-col gap-4">
                                    <span class="text-[11px] font-bold text-zinc-400 uppercase tracking-widest">Quick Play</span>
                                    <div class="text-sm font-semibold opacity-70 hover:opacity-100 cursor-pointer truncate" onclick="loadAudioPreset(1)">Song #1</div>
                                    <div class="text-sm font-semibold opacity-70 hover:opacity-100 cursor-pointer truncate" onclick="loadAudioPreset(2)">Song #2</div>
                                    <div class="text-sm font-semibold opacity-70 hover:opacity-100 cursor-pointer truncate" onclick="loadAudioPreset(3)">Song #3</div>
                                </div>
                            </div>
                            <!-- Main Content -->
                            <div class="flex-1 bg-gradient-to-b from-[#1e1e1e] to-[#121212] p-8 overflow-y-auto flex items-center justify-center">
                                <div class="text-center">
                                    <div class="w-64 h-64 mx-auto mb-8 bg-gradient-to-br from-[#1db954] to-[#1ed760] rounded-lg shadow-2xl flex items-center justify-center">
                                        <img id="spotify-album-art" src="https://img.icons8.com/color/96/spotify.png" class="w-32 h-32">
                                    </div>
                                    <h2 id="spotify-track-title" class="text-3xl font-bold mb-2">Select a Song</h2>
                                    <p id="spotify-track-artist" class="text-lg text-zinc-400 mb-8">Choose from the sidebar</p>
                                </div>
                            </div>
                        </div>
                        <!-- Player Bar -->
                        <div class="h-24 bg-[#181818] border-t border-zinc-800 px-4 flex items-center justify-between">
                            <div class="flex items-center gap-4 w-1/3">
                                <div id="player-art-small" class="w-14 h-14 rounded shadow bg-zinc-800 flex items-center justify-center">
                                    <img src="https://img.icons8.com/color/48/spotify.png" class="w-8 h-8">
                                </div>
                                <div class="flex flex-col">
                                    <span id="player-title" class="text-sm font-semibold">No track loaded</span>
                                    <span id="player-artist" class="text-[11px] text-zinc-400">-</span>
                                </div>
                                <img src="https://img.icons8.com/material-outlined/24/1db954/like.png" class="w-5 h-5 cursor-pointer">
                            </div>
                            <div class="flex flex-col items-center gap-2 w-1/3">
                                <div class="flex items-center gap-6">
                                    <img src="https://img.icons8.com/material-rounded/24/ffffff/shuffle.png" class="w-4 h-4 opacity-70 hover:opacity-100 cursor-pointer">
                                    <img src="https://img.icons8.com/material-rounded/24/ffffff/previous.png" class="w-5 h-5 opacity-70 hover:opacity-100 cursor-pointer" onclick="spotifyPrevTrack()">
                                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center hover:scale-105 transition-transform cursor-pointer" onclick="spotifyTogglePlayback()">
                                        <img id="spotify-play-icon" src="https://img.icons8.com/material-rounded/24/000000/play--v1.png" class="w-6 h-6">
                                    </div>
                                    <img src="https://img.icons8.com/material-rounded/24/ffffff/next.png" class="w-5 h-5 opacity-70 hover:opacity-100 cursor-pointer" onclick="spotifyNextTrack()">
                                    <img src="https://img.icons8.com/material-rounded/24/ffffff/repeat.png" class="w-4 h-4 opacity-70 hover:opacity-100 cursor-pointer">
                                </div>
                                <div class="flex items-center gap-2 w-full max-w-md">
                                    <span id="spotify-current-time" class="text-[10px] text-zinc-400 min-w-[30px] text-right">0:00</span>
                                    <div class="flex-1 h-1 bg-zinc-600 rounded-full cursor-pointer relative group" onclick="spotifySeekTrack(event, this)">
                                        <div id="spotify-progress-bar" class="absolute top-0 left-0 h-full bg-white group-hover:bg-[#1db954] rounded-full transition-colors" style="width: 0%"></div>
                                    </div>
                                    <span id="spotify-duration" class="text-[10px] text-zinc-400">0:00</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-end gap-3 w-1/3">
                                <img src="https://img.icons8.com/material-rounded/24/ffffff/speaker.png" class="w-4 h-4 opacity-70 hover:opacity-100 cursor-pointer">
                                <div class="w-24 h-1 bg-zinc-600 rounded-full cursor-pointer relative group" onclick="spotifySetVolume(event, this)">
                                    <div id="spotify-volume-bar" class="absolute top-0 left-0 h-full bg-white group-hover:bg-[#1db954] rounded-full transition-colors" style="width: 70%"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Hidden Audio Element -->
                        <audio id="spotify-audio-player" style="display: none;"></audio>
                    </div>
                `
            },
            'this-pc': {
                title: 'File Explorer',
                icon: 'https://img.icons8.com/color/48/folder-invoices--v1.png',
                content: `
                    <div class="h-full flex flex-col bg-white dark:bg-zinc-900 overflow-hidden explorer-container">
                        <div class="flex items-center gap-2 p-2 border-b border-gray-200 dark:border-zinc-800 bg-gray-50 dark:bg-zinc-800/50">
                            <div class="flex gap-1">
                                <button onclick="navigateExplorerBack()" class="p-1.5 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded disabled:opacity-30" id="explorer-back">
                                    <img src="https://img.icons8.com/ios-glyphs/15/null/left.png" class="dark:invert">
                                </button>
                                <button onclick="navigateExplorerForward()" class="p-1.5 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded disabled:opacity-30" id="explorer-forward">
                                    <img src="https://img.icons8.com/ios-glyphs/15/null/right.png" class="dark:invert">
                                </button>
                                <button onclick="navigateExplorerUp()" class="p-1.5 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded" id="explorer-up">
                                    <img src="https://img.icons8.com/ios-glyphs/15/null/up.png" class="dark:invert">
                                </button>
                            </div>
                            <div class="flex-1 flex items-center bg-white dark:bg-zinc-900 border border-gray-300 dark:border-zinc-700 rounded px-2 py-1 gap-2 overflow-hidden">
                                <img src="https://img.icons8.com/color/15/folder-invoices--v1.png">
                                <div class="flex items-center gap-1 text-xs whitespace-nowrap overflow-hidden" id="explorer-breadcrumbs">
                                    <!-- Breadcrumbs -->
                                </div>
                            </div>
                            <div class="w-48 bg-white dark:bg-zinc-900 border border-gray-300 dark:border-zinc-700 rounded px-2 py-1 flex items-center gap-2">
                                <img src="https://img.icons8.com/ios-glyphs/15/71717a/search.png">
                                <input type="text" placeholder="Search" class="bg-transparent border-none outline-none text-xs w-full">
                            </div>
                        </div>
                        <div class="flex flex-1 overflow-hidden">
                            <div class="w-40 border-r border-gray-200 dark:border-zinc-800 p-2 flex flex-col gap-1 text-[11px]">
                                ${['This PC', 'Desktop', 'Documents', 'Downloads', 'Pictures', 'Music', 'Videos'].map(item => `
                                    <div onclick="navigateExplorerTo('${item}')" 
                                         ondragover="handleFileDragOver(event)" 
                                         onitemdrop="handleFileDrop(event, '${item}')"
                                         class="flex items-center gap-2 p-1.5 hover:bg-gray-100 dark:hover:bg-zinc-800 rounded cursor-pointer explorer-sidebar-item">
                                        <img src="https://img.icons8.com/color/16/${item === 'This PC' ? 'monitor--v1' : 'folder-invoices--v1'}.png">
                                        <span>${item}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex-1 p-4 overflow-y-auto" id="explorer-grid">
                                <!-- File grid -->
                            </div>
                        </div>
                    </div>
                `,
                onMount: (win) => {
                    updateExplorerUI(win);
                }
            },
            'calculator': {
                title: 'Calculator',
                icon: 'https://img.icons8.com/color/48/calculator.png',
                width: 320,
                height: 480,
                content: `
                    <div class="h-full flex flex-col p-2 bg-[#f3f3f3] dark:bg-zinc-900">
                        <div id="calc-display" class="h-24 flex flex-col justify-end items-end p-4 text-3xl font-bold overflow-hidden">0</div>
                        <div class="grid grid-cols-4 gap-1 flex-1">
                            ${['%', 'CE', 'C', 'âŒ«', '1/x', 'xÂ²', 'âˆš', '/', '7', '8', '9', '*', '4', '5', '6', '-', '1', '2', '3', '+', '+/-', '0', '.', '='].map(b => `
                                <button class="calc-btn hover:bg-gray-200 dark:hover:bg-zinc-800 rounded text-sm font-semibold h-full w-full ${b === '=' ? 'bg-blue-600 text-white hover:bg-blue-700' : ''}">${b}</button>
                            `).join('')}
                        </div>
                    </div>
                `,
                onMount: (win) => {
                    const display = win.querySelector('#calc-display');
                    let current = '0';
                    let shouldReset = false;

                    win.querySelectorAll('.calc-btn').forEach(btn => {
                        btn.onclick = () => {
                            const val = btn.innerText;
                            
                            try {
                                if (val === '=') {
                                    // Sanitize and evaluate
                                    let expression = current.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
                                    current = String(eval(expression));
                                    shouldReset = true;
                                } else if (val === 'C' || val === 'CE') {
                                    current = '0';
                                } else if (val === 'âŒ«') {
                                    current = current.length > 1 ? current.slice(0, -1) : '0';
                                } else if (val === 'xÂ²') {
                                    current = String(Math.pow(parseFloat(current), 2));
                                    shouldReset = true;
                                } else if (val === 'âˆš') {
                                    current = String(Math.sqrt(parseFloat(current)));
                                    shouldReset = true;
                                } else if (val === '1/x') {
                                    current = String(1 / parseFloat(current));
                                    shouldReset = true;
                                } else if (val === '+/-') {
                                    current = String(parseFloat(current) * -1);
                                } else if (val === '%') {
                                    current = String(parseFloat(current) / 100);
                                } else {
                                    if (shouldReset && !isNaN(val)) {
                                        current = val;
                                        shouldReset = false;
                                    } else {
                                        if (current === '0' && !isNaN(val)) {
                                            current = val;
                                        } else {
                                            current += val;
                                        }
                                    }
                                }
                            } catch (e) {
                                current = 'Error';
                                shouldReset = true;
                            }
                            
                            // Limit display length
                            display.innerText = current.length > 12 ? parseFloat(current).toPrecision(8) : current;
                        };
                    });
                }
            },
            'temutube': {
                title: 'Temutube',
                icon: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSmHCqoQDr_Et05Q3esQGuyWgJW7VESNFij9w&s',
                width: 1200,
                height: 720,
                content: `
                    <div class="h-full flex flex-col bg-white dark:bg-zinc-950">
                        <!-- Header -->
                        <div class="bg-white dark:bg-zinc-900 border-b border-gray-200 dark:border-zinc-800 p-3 flex items-center gap-4">
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSmHCqoQDr_Et05Q3esQGuyWgJW7VESNFij9w&s" class="w-10 h-10">
                            <div class="flex-1 flex items-center gap-2">
                                <input type="text" placeholder="Search" class="temutube-search bg-gray-100 dark:bg-zinc-800 px-4 py-2 rounded-full text-sm w-96 outline-none dark:text-gray-200" />
                            </div>
                            <div class="flex items-center gap-4">
                                <button class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">âš™ï¸</button>
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold">U</div>
                            </div>
                        </div>
                        
                        <!-- Main Content -->
                        <div class="flex-1 flex">
                            <!-- Sidebar -->
                            <div class="w-56 bg-white dark:bg-zinc-900 border-r border-gray-200 dark:border-zinc-800 p-3 overflow-y-auto">
                                <div class="text-sm font-semibold text-gray-900 dark:text-white mb-4">HOME</div>
                                <div class="space-y-2">
                                    <div class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer dark:text-gray-200">ðŸ  Home</div>
                                    <div class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer dark:text-gray-200">ðŸ”¥ Trending</div>
                                    <div class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer dark:text-gray-200">ðŸ“¬ Subscriptions</div>
                                </div>
                                <div class="border-t border-gray-200 dark:border-zinc-800 my-4"></div>
                                <div class="text-sm font-semibold text-gray-900 dark:text-white mb-4">LIBRARY</div>
                                <div class="space-y-2">
                                    <div class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer dark:text-gray-200">ðŸ“‹ History</div>
                                    <div class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer dark:text-gray-200">â¤ï¸ Liked videos</div>
                                    <div class="flex items-center gap-3 p-3 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer dark:text-gray-200">â–¶ï¸ Watch later</div>
                                </div>
                            </div>
                            
                            <!-- Video Grid -->
                            <div class="flex-1 p-6 overflow-y-auto bg-gray-50 dark:bg-zinc-950">
                                <div id="temutube-grid" class="grid grid-cols-4 gap-4">
                                    <!-- Videos will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                onMount: (win) => {
                    const videoTitles = [
                        'Amazing Nature Documentary',
                        'How to Code in JavaScript',
                        'Cooking the Perfect Pasta',
                        'Deep Space Exploration',
                        'Gaming Marathon Stream',
                        'Music Production Tutorial',
                        'Travel Vlog Japan',
                        'Tech Review 2024',
                        'Workout Routine',
                        'Cat Videos Compilation',
                        'Web Development Tips',
                        'Photography Guide'
                    ];
                    
                    const channels = ['Discovery', 'WebDev Hub', 'Food Channel', 'Cosmos', 'Game Masters', 'Beat Makers', 'Travel Box', 'Tech Times', 'Fitness Pro', 'Pet Paradise', 'Code Academy', 'Photo School'];
                    
                    const grid = win.querySelector('#temutube-grid');
                    if (grid) {
                        grid.innerHTML = videoTitles.map((title, i) => `
                            <div class="cursor-pointer group temutube-video-item" data-index="${i}">
                                <div class="relative bg-gray-300 dark:bg-zinc-800 aspect-video rounded-lg overflow-hidden hover:rounded-xl transition-all hover:shadow-lg flex items-center justify-center group-hover:shadow-xl">
                                    <div class="absolute inset-0 bg-gradient-to-br from-blue-400 to-purple-600 opacity-60"></div>
                                    <div class="text-white text-4xl">â–¶ï¸</div>
                                </div>
                                <div class="mt-3">
                                    <h3 class="text-sm font-semibold text-gray-900 dark:text-white line-clamp-2 group-hover:text-blue-600 dark:group-hover:text-blue-400">${title}</h3>
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${channels[i]}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">${Math.floor(Math.random() * 1000) + 1}K views â€¢ ${Math.floor(Math.random() * 7) + 1} days ago</p>
                                </div>
                            </div>
                        `).join('');
                        
                        // Add click handlers to video items
                        grid.querySelectorAll('.temutube-video-item').forEach((item) => {
                            item.style.cursor = 'pointer';
                            item.onclick = () => {
                                const idx = parseInt(item.dataset.index);
                                showNotification('Temutube', `Playing: ${videoTitles[idx]}\nChannel: ${channels[idx]}`);
                            };
                        });
                    }
                    
                    // Search functionality
                    const searchInput = win.querySelector('.temutube-search');
                    if (searchInput) {
                        searchInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                showNotification('Temutube', `Search: "${searchInput.value}"\n\nShowing results...`);
                                searchInput.value = '';
                            }
                        });
                    }
                }
            },
            'edge': {
                title: 'Edge Browser',
                icon: 'https://upload.wikimedia.org/wikipedia/commons/9/98/Microsoft_Edge_logo_%282019%29.svg',
                content: `
                    <div class="h-full flex flex-col bg-white dark:bg-zinc-900 browser-container">
                        <div class="flex items-center gap-2 p-2 bg-gray-100 dark:bg-zinc-800">
                            <div class="flex gap-1">
                                <button class="p-1 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded">â†</button>
                                <button class="p-1 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded">â†’</button>
                                <button class="p-1 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded">â†»</button>
                            </div>
                            <input type="text" placeholder="Search or type a URL" class="browser-address-bar flex-1 bg-white dark:bg-zinc-900 px-3 py-1 rounded-full text-xs border border-gray-300 dark:border-zinc-700 outline-none">
                        </div>
                        <div class="browser-viewport flex-1 overflow-auto">
                            <!-- Connectivity dependent content injected here -->
                        </div>
                    </div>
                `,
                onMount: (win) => {
                    syncBrowserConnectivity(win);
                    const addressBar = win.querySelector('.browser-address-bar');
                    addressBar.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            const isOnline = state.wifi.enabled && state.wifi.connectedTo;
                            if (!isOnline) {
                                alert("No internet connection!");
                                return;
                            }
                            
                            let url = addressBar.value.trim();
                            if (!url) return;
                            
                            if (!url.startsWith('http')) {
                                // If it looks like a domain, add https, otherwise search google
                                if (url.includes('.') && !url.includes(' ')) {
                                    url = 'https://' + url;
                                } else {
                                    url = 'https://www.google.com/search?q=' + encodeURIComponent(url);
                                }
                            }
                            window.open(url, '_blank');
                        }
                    });
                }
            },
            'notepad': {
                title: 'Untitled - Notepad',
                icon: 'https://img.icons8.com/color/48/notepad.png',
                content: `
                    <div class="h-full flex flex-col notepad-container relative">
                        <div class="flex gap-1 px-1 py-1 text-xs border-b border-gray-200 dark:border-zinc-700 bg-gray-50 dark:bg-zinc-800">
                            <!-- File Menu -->
                            <div class="relative group">
                                <button class="px-3 py-1 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded">File</button>
                                <div class="absolute left-0 top-full hidden group-hover:block bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 shadow-lg z-50 py-1 w-48">
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer flex justify-between" onclick="notepadNew(this)"><span>New</span><span class="opacity-50">Ctrl+N</span></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer flex justify-between" onclick="notepadSave(this)"><span>Save</span><span class="opacity-50">Ctrl+S</span></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer" onclick="notepadSaveAs(this)">Save As...</div>
                                    <div class="border-t border-gray-200 dark:border-zinc-700 my-1"></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer" onclick="closeWindow('notepad')">Exit</div>
                                </div>
                            </div>
                            <!-- Edit Menu -->
                            <div class="relative group">
                                <button class="px-3 py-1 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded">Edit</button>
                                <div class="absolute left-0 top-full hidden group-hover:block bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 shadow-lg z-50 py-1 w-48">
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer flex justify-between" onclick="notepadEditAction('undo', this)"><span>Undo</span><span class="opacity-50">Ctrl+Z</span></div>
                                    <div class="border-t border-gray-200 dark:border-zinc-700 my-1"></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer flex justify-between" onclick="notepadEditAction('cut', this)"><span>Cut</span><span class="opacity-50">Ctrl+X</span></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer flex justify-between" onclick="notepadEditAction('copy', this)"><span>Copy</span><span class="opacity-50">Ctrl+C</span></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer flex justify-between" onclick="notepadEditAction('paste', this)"><span>Paste</span><span class="opacity-50">Ctrl+V</span></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer flex justify-between" onclick="notepadEditAction('delete', this)"><span>Delete</span><span class="opacity-50">Del</span></div>
                                    <div class="border-t border-gray-200 dark:border-zinc-700 my-1"></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer flex justify-between" onclick="notepadEditAction('selectAll', this)"><span>Select All</span><span class="opacity-50">Ctrl+A</span></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer flex justify-between" onclick="notepadEditAction('timeDate', this)"><span>Time/Date</span><span class="opacity-50">F5</span></div>
                                </div>
                            </div>
                            <!-- Format Menu -->
                            <div class="relative group">
                                <button class="px-3 py-1 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded">Format</button>
                                <div class="absolute left-0 top-full hidden group-hover:block bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 shadow-lg z-50 py-1 w-48">
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer flex justify-between" onclick="notepadFormatAction('wordWrap', this)"><span>Word Wrap</span><span id="wrap-check">âœ“</span></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer" onclick="notepadFormatAction('font', this)">Font...</div>
                                </div>
                            </div>
                            <!-- View Menu -->
                            <div class="relative group">
                                <button class="px-3 py-1 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded">View</button>
                                <div class="absolute left-0 top-full hidden group-hover:block bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 shadow-lg z-50 py-1 w-48">
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer flex justify-between" onclick="notepadViewAction('zoomIn', this)"><span>Zoom In</span><span class="opacity-50">Ctrl++</span></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer flex justify-between" onclick="notepadViewAction('zoomOut', this)"><span>Zoom Out</span><span class="opacity-50">Ctrl+-</span></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer" onclick="notepadViewAction('zoomRestore', this)">Restore Default Zoom</div>
                                    <div class="border-t border-gray-200 dark:border-zinc-700 my-1"></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer flex justify-between" onclick="notepadViewAction('statusBar', this)"><span>Status Bar</span><span id="status-check">âœ“</span></div>
                                </div>
                            </div>
                            <!-- Help Menu -->
                            <div class="relative group">
                                <button class="px-3 py-1 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded">Help</button>
                                <div class="absolute left-0 top-full hidden group-hover:block bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 shadow-lg z-50 py-1 w-48">
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer" onclick="notepadHelpAction('viewHelp', this)">View Help</div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer" onclick="notepadHelpAction('sendFeedback', this)">Send Feedback</div>
                                    <div class="border-t border-gray-200 dark:border-zinc-700 my-1"></div>
                                    <div class="px-4 py-1.5 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer" onclick="notepadHelpAction('about', this)">About Notepad</div>
                                </div>
                            </div>
                        </div>
                        <textarea class="flex-1 p-2 outline-none resize-none bg-transparent font-mono text-sm dark:text-gray-200" spellcheck="false" style="white-space: pre;"></textarea>
                        <div id="notepad-status-bar" class="flex justify-end gap-6 px-4 py-1 text-[10px] border-t border-gray-200 dark:border-zinc-700 bg-gray-50 dark:bg-zinc-800 opacity-70">
                            <span>Ln 1, Col 1</span>
                            <span>100%</span>
                            <span>Windows (CRLF)</span>
                            <span>UTF-8</span>
                        </div>
                    </div>
                `,
                onMount: (win) => {
                    win.dataset.fileName = 'Untitled.txt';
                    win.dataset.zoom = 100;
                    
                    const textarea = win.querySelector('textarea');
                    const statusBarLineCol = win.querySelector('#notepad-status-bar span:first-child');
                    
                    // Initialize menu checks
                    win.querySelector('#wrap-check').style.visibility = textarea.style.whiteSpace === 'pre-wrap' ? 'visible' : 'hidden';
                    win.querySelector('#status-check').style.visibility = 'visible';

                    const updateStatus = () => {
                        const text = textarea.value.substring(0, textarea.selectionStart);
                        const lines = text.split('\n');
                        statusBarLineCol.innerText = `Ln ${lines.length}, Col ${lines[lines.length-1].length + 1}`;
                    };

                    textarea.addEventListener('input', updateStatus);
                    textarea.addEventListener('click', updateStatus);
                    textarea.addEventListener('keyup', updateStatus);
                    textarea.addEventListener('focus', updateStatus);
                }
            },
            'recycle-bin': {
                title: 'Recycle Bin',
                icon: 'https://img.icons8.com/color/48/trash--v1.png',
                content: `
                    <div class="h-full flex flex-col bg-white dark:bg-zinc-900 overflow-hidden explorer-container" id="recycle-bin-container">
                        <div class="flex items-center gap-2 p-2 border-b border-gray-200 dark:border-zinc-800 bg-gray-50 dark:bg-zinc-800/50">
                            <button onclick="emptyRecycleBin()" class="flex items-center gap-2 px-3 py-1 hover:bg-red-100 dark:hover:bg-red-900/20 text-red-600 rounded text-xs font-semibold transition-colors">
                                <img src="https://img.icons8.com/color/16/trash--v1.png">
                                Empty Recycle Bin
                            </button>
                        </div>
                        <div class="flex-1 p-4 overflow-y-auto" id="recycle-bin-grid">
                            <!-- Items will be rendered here -->
                        </div>
                    </div>
                `,
                onMount: (win) => {
                    renderRecycleBin(win);
                }
            },
            'weather': {
                title: 'Weather',
                icon: 'https://img.icons8.com/color/48/partly-cloudy-day.png',
                width: 600,
                height: 500,
                content: `
                    <div class="h-full flex flex-col bg-gradient-to-b from-blue-400 to-blue-600 text-white p-8 overflow-hidden">
                        <div class="flex justify-between items-start mb-8">
                            <div>
                                <h2 class="text-3xl font-bold">New York, NY</h2>
                                <p class="opacity-80" id="weather-app-date">Monday, October 23</p>
                            </div>
                            <div class="text-right">
                                <img id="weather-app-hero-icon" src="https://img.icons8.com/color/96/cloud.png" class="w-20 h-20 -mt-4">
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-8 mb-12">
                            <div id="weather-app-temp" class="text-7xl font-light">22Â°C</div>
                            <div class="flex flex-col">
                                <span id="weather-app-desc" class="text-xl font-semibold">Mostly Cloudy</span>
                                <span class="opacity-80">Feels like <span id="weather-app-feels">24</span>Â°C</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-5 gap-4">
                            ${['Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => `
                                <div class="bg-white/10 p-3 rounded-xl flex flex-col items-center gap-2 backdrop-blur-sm">
                                    <span class="text-xs font-semibold">${day}</span>
                                    <img src="https://img.icons8.com/color/32/${['sun', 'rain', 'cloud', 'partly-cloudy-day', 'storm'][i % 5]}.png" class="w-8 h-8">
                                    <span class="text-sm font-bold">${20 + (i * 2)}Â°</span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="mt-auto p-4 bg-white/10 rounded-xl backdrop-blur-sm border border-white/20">
                            <h3 class="text-sm font-bold mb-1">Air Quality: Good</h3>
                            <p class="text-[11px] opacity-80">Air quality is considered satisfactory, and air pollution poses little or no risk.</p>
                        </div>
                    </div>
                `,
                onMount: (win) => {
                    const updateDate = () => {
                        const now = new Date();
                        win.querySelector('#weather-app-date').innerText = now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
                    };
                    updateDate();
                    // Sync with current taskbar weather
                    win.querySelector('#weather-app-temp').innerText = document.getElementById('weather-taskbar-temp').innerText;
                    win.querySelector('#weather-app-desc').innerText = document.getElementById('weather-taskbar-desc').innerText;
                    win.querySelector('#weather-app-hero-icon').src = document.getElementById('weather-taskbar-icon').src;
                }
            },
            'settings': {
                title: 'Settings',
                icon: 'https://img.icons8.com/color/48/settings--v1.png',
                content: `
                    <div class="flex h-full bg-[#f3f3f3] dark:bg-zinc-900" id="settings-app">
                        <div class="w-48 border-r border-gray-200 dark:border-zinc-800 p-4 flex flex-col gap-1" id="settings-sidebar">
                            <div data-tab="system" class="settings-tab-btn p-2 bg-blue-100 dark:bg-blue-900/30 rounded text-blue-600 dark:text-blue-400 font-semibold text-xs cursor-pointer">System</div>
                            <div data-tab="network" class="settings-tab-btn p-2 hover:bg-gray-200 dark:hover:bg-zinc-800 rounded text-xs cursor-pointer">Network & Internet</div>
                            <div data-tab="personalization" class="settings-tab-btn p-2 hover:bg-gray-200 dark:hover:bg-zinc-800 rounded text-xs cursor-pointer">Personalization</div>
                            <div data-tab="accessibility" class="settings-tab-btn p-2 hover:bg-gray-200 dark:hover:bg-zinc-800 rounded text-xs cursor-pointer">Accessibility</div>
                            <div class="mt-auto p-2 hover:bg-gray-200 dark:hover:bg-zinc-800 rounded text-xs cursor-pointer opacity-70" onclick="alert('Windows 11 Online Demo\\nVersion 1.0\\nBuild 2024')">About</div>
                        </div>
                        <div class="flex-1 p-8 overflow-y-auto" id="settings-main-content">
                            <!-- System Tab Content -->
                            <div id="tab-system">
                                <h1 class="text-2xl font-bold mb-6">System</h1>
                                <div class="flex flex-col gap-4">
                                    <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-zinc-700">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-semibold">Brightness</span>
                                            <span id="settings-brightness-val" class="text-xs">100%</span>
                                        </div>
                                        <input type="range" class="w-full" value="100" oninput="setBrightness(this.value)">
                                    </div>
                                    <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-zinc-700">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-semibold">Volume</span>
                                            <span id="settings-volume-val" class="text-xs">50%</span>
                                        </div>
                                        <input type="range" class="w-full" value="50" oninput="setVolume(this.value)">
                                    </div>
                                    <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-zinc-700 flex justify-between items-center">
                                        <div>
                                            <div class="text-sm font-semibold">Night Light</div>
                                            <div class="text-[11px] text-gray-500">Reduce blue light</div>
                                        </div>
                                        <input type="checkbox" id="night-light-check" class="w-4 h-4" onchange="toggleNightLight(this.checked)">
                                    </div>
                                    <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-zinc-700">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-semibold">Battery</span>
                                            <span id="settings-battery-val" class="text-xs">85%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-zinc-700 h-2 rounded-full overflow-hidden">
                                            <div id="settings-battery-bar" class="bg-green-500 h-full w-[85%]"></div>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-2">Discharging - 4 hours remaining</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Network Tab Content -->
                            <div id="tab-network" class="hidden">
                                <h1 class="text-2xl font-bold mb-6">Network & Internet</h1>
                                <div class="flex flex-col gap-4">
                                    <div class="bg-white dark:bg-zinc-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-zinc-700">
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="flex items-center gap-4">
                                                <div class="p-3 bg-blue-500/10 rounded-full">
                                                    <img id="wifi-status-icon" src="https://img.icons8.com/ios-glyphs/60/0067c0/wi-fi.png" class="w-8 h-8" alt="wifi.png">
                                                </div>
                                                <div>
                                                    <div class="text-lg font-bold" id="wifi-name-display">Home_Wi-Fi</div>
                                                    <div class="text-xs text-green-500 font-semibold" id="wifi-connected-status">Connected, secured</div>
                                                </div>
                                            </div>
                                            <button onclick="toggleWifi()" id="wifi-toggle-btn" class="bg-blue-600 text-white px-4 py-1 rounded text-sm font-medium">Disconnect</button>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4 text-xs">
                                            <div class="p-3 bg-gray-50 dark:bg-zinc-700/50 rounded">
                                                <div class="opacity-60 mb-1">Properties</div>
                                                <div class="font-mono">IP: 192.168.1.15</div>
                                            </div>
                                            <div class="p-3 bg-gray-50 dark:bg-zinc-700/50 rounded">
                                                <div class="opacity-60 mb-1">Data usage</div>
                                                <div>14.5 GB (Last 30 days)</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <h3 class="text-sm font-bold mb-3">Available networks</h3>
                                        <div id="wifi-networks-list" class="flex flex-col gap-1"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Personalization Tab Content -->
                            <div id="tab-personalization" class="hidden">
                                <h1 class="text-2xl font-bold mb-6">Personalization</h1>
                                <div class="flex flex-col gap-6">
                                    <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-zinc-700">
                                        <h3 class="text-sm font-semibold mb-4">Background</h3>
                                        <div class="grid grid-cols-3 gap-2">
                                            <div class="aspect-video bg-cover bg-center rounded cursor-pointer border-2 border-transparent hover:border-blue-500" style="background-image: url('https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=80')" onclick="setWallpaper(this.style.backgroundImage)"></div>
                                            <div class="aspect-video bg-cover bg-center rounded cursor-pointer border-2 border-transparent hover:border-blue-500" style="background-image: url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=80')" onclick="setWallpaper(this.style.backgroundImage)"></div>
                                            <div class="aspect-video bg-cover bg-center rounded cursor-pointer border-2 border-transparent hover:border-blue-500" style="background-image: url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=80')" onclick="setWallpaper(this.style.backgroundImage)"></div>
                                        </div>
                                    </div>
                                    <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-zinc-700 flex justify-between items-center">
                                        <div>
                                            <div class="text-sm font-semibold">Dark Mode</div>
                                            <div class="text-[11px] text-gray-500">Enable system-wide dark theme</div>
                                        </div>
                                        <input type="checkbox" id="dark-mode-check" class="w-4 h-4" onchange="setTheme(this.checked ? 'dark' : 'light')">
                                    </div>
                                </div>
                            </div>

                            <!-- Accessibility Tab Content -->
                            <div id="tab-accessibility" class="hidden">
                                <h1 class="text-2xl font-bold mb-6">Accessibility</h1>
                                <div class="flex flex-col gap-4">
                                    <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-zinc-700">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-semibold">Text Size</span>
                                            <span id="settings-font-val" class="text-xs">14px</span>
                                        </div>
                                        <input type="range" class="w-full" min="12" max="24" value="14" oninput="setFontSize(this.value)">
                                    </div>
                                    <div class="bg-white dark:bg-zinc-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-zinc-700 flex justify-between items-center">
                                        <div>
                                            <div class="text-sm font-semibold">Transparency Effects</div>
                                            <div class="text-[11px] text-gray-500">Windows and surfaces appear translucent</div>
                                        </div>
                                        <input type="checkbox" id="transparency-check" class="w-4 h-4" onchange="setTransparency(this.checked)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                onMount: (win) => {
                    // Sync UI with state
                    win.querySelector('input[type="range"][oninput*="setBrightness"]').value = state.brightness;
                    win.querySelector('#settings-brightness-val').innerText = state.brightness + '%';
                    win.querySelector('input[type="range"][oninput*="setVolume"]').value = state.volume;
                    win.querySelector('#settings-volume-val').innerText = state.volume + '%';
                    win.querySelector('#night-light-check').checked = document.getElementById('desktop').style.filter !== 'none';
                    win.querySelector('#dark-mode-check').checked = state.theme === 'dark';
                    win.querySelector('input[type="range"][oninput*="setFontSize"]').value = state.fontSize;
                    win.querySelector('#settings-font-val').innerText = state.fontSize + 'px';
                    win.querySelector('#transparency-check').checked = state.transparency;

                    // Tab switching
                    const sideBtns = win.querySelectorAll('.settings-tab-btn');
                    const contents = {
                        system: win.querySelector('#tab-system'),
                        network: win.querySelector('#tab-network'),
                        personalization: win.querySelector('#tab-personalization'),
                        accessibility: win.querySelector('#tab-accessibility')
                    };

                    sideBtns.forEach(btn => {
                        btn.onclick = () => {
                            sideBtns.forEach(b => {
                                b.classList.remove('bg-blue-100', 'dark:bg-blue-900/30', 'text-blue-600', 'dark:text-blue-400', 'font-semibold');
                                b.classList.add('hover:bg-gray-200', 'dark:hover:bg-zinc-800');
                            });
                            btn.classList.add('bg-blue-100', 'dark:bg-blue-900/30', 'text-blue-600', 'dark:text-blue-400', 'font-semibold');
                            btn.classList.remove('hover:bg-gray-200', 'dark:hover:bg-zinc-800');

                            Object.values(contents).forEach(c => c.classList.add('hidden'));
                            contents[btn.dataset.tab].classList.remove('hidden');
                            
                            if (btn.dataset.tab === 'network') updateNetworkUI(win);
                        };
                    });

                    updateNetworkUI(win);
                }
            },
            'uranidiot': {
                title: 'You Are An Idiot',
                icon: 'https://upload.wikimedia.org/wikipedia/commons/5/5c/You_Are_An_Idiot_screen.gif',
                width: 600,
                height: 500,
                content: `
                    <div class="h-full flex flex-col bg-[#1e1e1e] text-[#e0e0e0] vscode-container" style="font-family: 'Segoe UI Mono', 'Courier New', monospace;" data-theme="dark" data-font-size="13">
                        <!-- Menu Bar -->
                        <div class="flex h-8 items-center bg-[#323233] border-b border-[#3e3e42] px-2 gap-6 text-[11px]">
                            <div class="hover:bg-[#3e3e42] px-2 py-1 cursor-pointer">File</div>
                            <div class="hover:bg-[#3e3e42] px-2 py-1 cursor-pointer">Edit</div>
                            <div class="hover:bg-[#3e3e42] px-2 py-1 cursor-pointer">View</div>
                            <div class="hover:bg-[#3e3e42] px-2 py-1 cursor-pointer" onclick="vscodeToggleSettings(event)">Settings</div>
                            <div class="hover:bg-[#3e3e42] px-2 py-1 cursor-pointer">Help</div>
                        </div>
                        
                        <!-- Main Container -->
                        <div class="flex flex-1 overflow-hidden">
                            <!-- Sidebar -->
                            <div id="vscode-sidebar" class="w-72 bg-[#252526] border-r border-[#3e3e42] flex flex-col">
                                <!-- Sidebar Tabs -->
                                <div class="flex h-12 items-center bg-[#2d2d30] border-b border-[#3e3e42] gap-1 px-2">
                                    <div class="vscode-sidebar-tab active flex-1 text-center py-2 text-[12px] hover:bg-[#3e3e42] cursor-pointer rounded" data-tab="explorer">ðŸ“</div>
                                    <div class="vscode-sidebar-tab flex-1 text-center py-2 text-[12px] hover:bg-[#3e3e42] cursor-pointer rounded" data-tab="search">ðŸ”</div>
                                    <div class="vscode-sidebar-tab flex-1 text-center py-2 text-[12px] hover:bg-[#3e3e42] cursor-pointer rounded" data-tab="extensions">ðŸ“¦</div>
                                </div>
                                
                                <!-- File Explorer -->
                                <div id="vscode-explorer" class="vscode-sidebar-content flex-1 overflow-y-auto p-2 text-[12px]">
                                    <div class="mb-2">
                                        <div class="hover:bg-[#2d2d30] px-2 py-1 rounded cursor-pointer flex items-center gap-2 font-semibold">
                                            <span>â–¼</span>
                                            <span>myproject</span>
                                        </div>
                                        <div class="ml-4 space-y-1">
                                            <div class="vscode-file hover:bg-[#2d2d30] px-2 py-1 rounded cursor-pointer flex items-center gap-2" data-file="index.js">
                                                <span>ðŸ“„</span><span class="text-[#ce9178]">index.js</span>
                                            </div>
                                            <div class="vscode-file hover:bg-[#2d2d30] px-2 py-1 rounded cursor-pointer flex items-center gap-2" data-file="index.html">
                                                <span>ðŸ“„</span><span class="text-[#ce9178]">index.html</span>
                                            </div>
                                            <div class="vscode-file hover:bg-[#2d2d30] px-2 py-1 rounded cursor-pointer flex items-center gap-2" data-file="style.css">
                                                <span>ðŸ“„</span><span class="text-[#ce9178]">style.css</span>
                                            </div>
                                            <div class="vscode-file hover:bg-[#2d2d30] px-2 py-1 rounded cursor-pointer flex items-center gap-2" data-file="utils.py">
                                                <span>ðŸ“„</span><span class="text-[#ce9178]">utils.py</span>
                                            </div>
                                            <div class="hover:bg-[#2d2d30] px-2 py-1 rounded cursor-pointer flex items-center gap-2">
                                                <span>ðŸ“ src</span>
                                            </div>
                                            <div class="hover:bg-[#2d2d30] px-2 py-1 rounded cursor-pointer flex items-center gap-2">
                                                <span>ðŸ“ public</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Extensions Tab -->
                                <div id="vscode-extensions" class="vscode-sidebar-content hidden flex-1 overflow-y-auto p-2 text-[12px]">
                                    <div class="space-y-2">
                                        <div class="bg-[#2d2d30] p-2 rounded">
                                            <div class="font-semibold text-[#4ec9b0]">Prettier</div>
                                            <div class="text-[11px] text-[#999]">Code formatter</div>
                                        </div>
                                        <div class="bg-[#2d2d30] p-2 rounded">
                                            <div class="font-semibold text-[#4ec9b0]">Python</div>
                                            <div class="text-[11px] text-[#999]">Python language support</div>
                                        </div>
                                        <div class="bg-[#2d2d30] p-2 rounded">
                                            <div class="font-semibold text-[#4ec9b0]">Live Server</div>
                                            <div class="text-[11px] text-[#999]">Launch development server</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Editor Area -->
                            <div class="flex-1 bg-[#1e1e1e] flex flex-col overflow-hidden">
                                <!-- Tab Bar -->
                                <div class="flex h-10 items-center bg-[#252526] border-b border-[#3e3e42] text-[12px] gap-1 px-2 overflow-x-auto">
                                    <div class="vscode-tab active flex items-center gap-2 px-3 py-2 bg-[#1e1e1e] border-b-2 border-[#007acc] hover:bg-[#2d2d30]" data-file="index.js">
                                        <span>âœ•</span>
                                        <span class="text-[#ce9178]">index.js</span>
                                    </div>
                                    <div class="vscode-tab flex items-center gap-2 px-3 py-2 hover:bg-[#2d2d30]" data-file="index.html">
                                        <span>âœ•</span>
                                        <span class="text-[#ce9178]">index.html</span>
                                    </div>
                                    <div class="vscode-tab flex items-center gap-2 px-3 py-2 hover:bg-[#2d2d30]" data-file="style.css">
                                        <span>âœ•</span>
                                        <span class="text-[#ce9178]">style.css</span>
                                    </div>
                                </div>
                                
                                <!-- Editor Content -->
                                <div class="flex-1 overflow-auto p-4 font-mono leading-relaxed" id="vscode-editor">
                                    <div class="vscode-file-content" data-file="index.js" style="display: block;">
                                        <div class="text-[#6a9955]">// JavaScript File</div>
                                        <div class="text-[#569cd6]">function</div>
                                        <div><span class="text-[#dcdcaa]">helloWorld</span>() {</div>
                                        <div class="ml-8"><span class="text-[#d4d4d4]">console.</span><span class="text-[#dcdcaa]">log</span>(<span class="text-[#ce9178]">'Hello World!'</span>);</div>
                                        <div>}</div>
                                        <div></div>
                                        <div class="text-[#dcdcaa]">helloWorld</div><span class="text-[#d4d4d4]">();</span>
                                    </div>
                                    <div class="vscode-file-content" data-file="index.html" style="display: none;">
                                        <div class="text-[#569cd6]">&lt;!DOCTYPE</div> <span class="text-[#d4d4d4]">html&gt;</span>
                                        <div class="text-[#569cd6]">&lt;html</div>
                                        <div class="ml-4 text-[#dcdcaa]">lang<span class="text-[#d4d4d4]">=</span><span class="text-[#ce9178]">"en"</span><span class="text-[#569cd6]">&gt;</span></div>
                                        <div class="text-[#569cd6]">&lt;head&gt;</div>
                                        <div class="ml-4"><span class="text-[#569cd6]">&lt;title&gt;</span>Welcome<span class="text-[#569cd6]">&lt;/title&gt;</span></div>
                                        <div class="text-[#569cd6]">&lt;/head&gt;</div>
                                        <div class="text-[#569cd6]">&lt;body&gt;</div>
                                        <div class="ml-4"><span class="text-[#569cd6]">&lt;h1&gt;</span>Hello!<span class="text-[#569cd6]">&lt;/h1&gt;</span></div>
                                        <div class="text-[#569cd6]">&lt;/body&gt;</div>
                                        <div class="text-[#569cd6]">&lt;/html&gt;</span></div>
                                    </div>
                                    <div class="vscode-file-content" data-file="style.css" style="display: none;">
                                        <div class="text-[#d4d4d4]">body {</div>
                                        <div class="ml-4"><span class="text-[#dcdcaa]">font-family</span><span class="text-[#d4d4d4]">:</span> <span class="text-[#ce9178]">Arial, sans-serif</span><span class="text-[#d4d4d4]">;</span></div>
                                        <div class="ml-4"><span class="text-[#dcdcaa]">background-color</span><span class="text-[#d4d4d4]">:</span> <span class="text-[#ce9178]">#f5f5f5</span><span class="text-[#d4d4d4]">;</span></div>
                                        <div>}</div>
                                        <div></div>
                                        <div class="text-[#d4d4d4]">h1 {</div>
                                        <div class="ml-4"><span class="text-[#dcdcaa]">color</span><span class="text-[#d4d4d4]">:</span> <span class="text-[#ce9178]">#333</span><span class="text-[#d4d4d4]">;</span></div>
                                        <div>}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Terminal Panel -->
                        <div id="vscode-terminal" class="h-40 bg-[#1e1e1e] border-t border-[#3e3e42] flex flex-col">
                            <div class="flex items-center bg-[#252526] border-b border-[#3e3e42] h-8 px-2 text-[11px] gap-2">
                                <div class="hover:bg-[#3e3e42] px-2 py-1 cursor-pointer border-b border-[#007acc]">Terminal</div>
                                <div class="hover:bg-[#3e3e42] px-2 py-1 cursor-pointer">Output</div>
                                <div class="ml-auto cursor-pointer hover:bg-[#3e3e42] px-2" onclick="document.getElementById('vscode-terminal').style.display='none'">âŒ„</div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-3 text-[12px] font-mono">
                                <div class="text-[#4ec9b0]">user@computer:~/myproject</div>
                                <div class="text-[#dcdcaa]">$ node index.js</div>
                                <div class="text-[#00ff00] mt-1">Hello World!</div>
                                <div></div>
                                <div class="text-[#4ec9b0]">user@computer:~/myproject</div>
                                <div class="text-[#dcdcaa]">$ </div>
                            </div>
                        </div>
                        
                        <!-- Status Bar -->
                        <div class="h-6 bg-[#007acc] flex items-center px-3 text-[11px] gap-4 text-white">
                            <div>Ln 1, Col 1</div>
                            <div>UTF-8</div>
                            <div>LF</div>
                            <div>JavaScript</div>
                            <div class="ml-auto">Prettier 2.8.0</div>
                        </div>
                        
                        <!-- Settings Panel (Hidden) -->
                        <div id="vscode-settings-panel" style="display: none; position: absolute; top: 30px; right: 20px; width: 350px; height: auto; background: #1e1e1e; border: 1px solid #3e3e42; border-radius: 8px; z-index: 1000; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
                            <div class="bg-[#252526] border-b border-[#3e3e42] p-3 font-semibold text-[12px] flex justify-between items-center">
                                Settings
                                <span onclick="vscodeToggleSettings()" class="cursor-pointer hover:bg-[#3e3e42] w-6 h-6 flex items-center justify-center rounded">âœ•</span>
                            </div>
                            <div class="p-4 space-y-4 max-h-96 overflow-y-auto text-[12px]">
                                <div>
                                    <label class="block text-[#dcdcaa] mb-2">Editor Theme</label>
                                    <select id="vscode-theme-select" class="w-full bg-[#3e3e42] text-white px-2 py-1 rounded border border-[#555] text-[11px]" onchange="vscodeChangeTheme(this.value)">
                                        <option value="dark">Dark (Default)</option>
                                        <option value="light">Light</option>
                                        <option value="monokai">Monokai</option>
                                        <option value="dracula">Dracula</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[#dcdcaa] mb-2">Font Size: <span id="font-size-display">13</span>px</label>
                                    <input type="range" id="vscode-font-size" min="10" max="24" value="13" class="w-full" onchange="vscodeChangeFontSize(this.value)">
                                </div>
                                <div>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="vscode-word-wrap" checked onchange="vscodeToggleWordWrap(this.checked)">
                                        <span class="text-[#dcdcaa]">Word Wrap</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="vscode-minimap" checked>
                                        <span class="text-[#dcdcaa]">Show Minimap</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="vscode-line-numbers" checked>
                                        <span class="text-[#dcdcaa]">Line Numbers</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="block text-[#dcdcaa] mb-2">Tab Size</label>
                                    <select class="w-full bg-[#3e3e42] text-white px-2 py-1 rounded border border-[#555] text-[11px]">
                                        <option>2</option>
                                        <option selected>4</option>
                                        <option>8</option>
                                    </select>
                                </div>
                                <button onclick="vscodeToggleSettings()" class="w-full bg-[#007acc] hover:bg-[#005a9e] text-white py-2 rounded text-[11px] font-semibold mt-4">Close Settings</button>
                            </div>
                        </div>
                    </div>
                `,
                onMount: (win) => {
                    const container = win.querySelector('.vscode-container');
                    const editorContent = win.querySelector('#vscode-editor');
                    const tabs = win.querySelectorAll('.vscode-tab');
                    const sidebarTabs = win.querySelectorAll('.vscode-sidebar-tab');
                    const files = win.querySelectorAll('.vscode-file');
                    
                    // Tab switching
                    tabs.forEach(tab => {
                        tab.onclick = () => {
                            tabs.forEach(t => t.classList.remove('active', 'border-b-2', 'border-[#007acc]'));
                            tab.classList.add('active', 'border-b-2', 'border-[#007acc]');
                            
                            const fileName = tab.dataset.file;
                            editorContent.querySelectorAll('.vscode-file-content').forEach(content => {
                                content.style.display = content.dataset.file === fileName ? 'block' : 'none';
                            });
                        };
                    });
                    
                    // File clicking
                    files.forEach(file => {
                        file.onclick = () => {
                            const fileName = file.dataset.file;
                            let tab = Array.from(tabs).find(t => t.dataset.file === fileName);
                            if (!tab) {
                                const newTab = document.createElement('div');
                                newTab.className = 'vscode-tab flex items-center gap-2 px-3 py-2 hover:bg-[#2d2d30]';
                                newTab.dataset.file = fileName;
                                newTab.innerHTML = `<span>âœ•</span><span class="text-[#ce9178]">${fileName}</span>`;
                                newTab.onclick = (e) => {
                                    if (e.target.innerText === 'âœ•') {
                                        newTab.remove();
                                    } else {
                                        tabs.forEach(t => t.classList.remove('active', 'border-b-2', 'border-[#007acc]'));
                                        newTab.classList.add('active', 'border-b-2', 'border-[#007acc]');
                                    }
                                };
                                win.querySelector('.vscode-tab').parentElement.appendChild(newTab);
                                tab = newTab;
                            }
                            tab.click();
                        };
                    });
                    
                    // Sidebar tab switching
                    sidebarTabs.forEach(tab => {
                        tab.onclick = () => {
                            sidebarTabs.forEach(t => t.classList.remove('active'));
                            tab.classList.add('active');
                            
                            const tabType = tab.dataset.tab;
                            win.querySelectorAll('.vscode-sidebar-content').forEach(content => {
                                content.style.display = content.id.includes(tabType) ? 'block' : 'none';
                            });
                        };
                    });
                    
                    window.vscodeToggleSettings = (e) => {
                        const panel = win.querySelector('#vscode-settings-panel');
                        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                    };
                    
                    window.vscodeChangeTheme = (theme) => {
                        container.dataset.theme = theme;
                    };
                    
                    window.vscodeChangeFontSize = (size) => {
                        container.style.fontSize = size + 'px';
                        win.querySelector('#font-size-display').innerText = size;
                        container.dataset.fontSize = size;
                    };
                    
                    window.vscodeToggleWordWrap = (checked) => {
                        editorContent.style.whiteSpace = checked ? 'pre-wrap' : 'pre';
                    };
                }
            },
            'uranidiot': {
                title: 'uranidiot',
                icon: 'https://upload.wikimedia.org/wikipedia/commons/5/5c/You_Are_An_Idiot_screen.gif',
                width: 800,
                height: 600,
                content: `
                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000; overflow: hidden;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/5/5c/You_Are_An_Idiot_screen.gif" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        <audio id="uranidiot-audio" autoplay loop style="display: none;">
                            <source src="https://cdn.discordapp.com/attachments/1362855493768315030/1465016583738101984/you-are-an-idiot.mp3?ex=69779284&is=69764104&hm=17bd9335c91ca85fd53447d718084ef806843215da8dc5edb2cca456201b99a0&" type="audio/mpeg">
                        </audio>
                    </div>
                `,
                onMount: (win) => {
                    // Remove close button
                    const closeBtn = win.querySelector('[onclick*="closeWindow"]');
                    if (closeBtn) closeBtn.style.display = 'none';
                    
                    // Prevent closing via keyboard or other methods
                    win.dataset.uncloseable = 'true';
                }
            }
        };

        // Window Management
        function updateTaskbarIcon(id, action) {
            const icon = document.querySelector(`.taskbar-icon[data-app-id="${id}"]`);
            if (icon) {
                if (action === 'add') {
                    icon.classList.add('open');
                } else if (action === 'remove') {
                    icon.classList.remove('open', 'focused');
                } else if (action === 'focus') {
                    document.querySelectorAll('.taskbar-icon').forEach(i => i.classList.remove('focused'));
                    icon.classList.add('focused');
                }
            }
        }

        let contextMenuAppId = null;

        function showContextMenu(event, appId) {
            event.preventDefault();
            contextMenuAppId = appId;
            
            const menu = document.getElementById('taskbar-context-menu');
            const pinBtn = document.getElementById('context-pin-btn');
            const unpinBtn = document.getElementById('context-unpin-btn');
            const closeBtn = document.getElementById('context-close-btn');
            
            const isPinned = state.pinnedApps.includes(appId);
            pinBtn.classList.toggle('hidden', isPinned);
            unpinBtn.classList.toggle('hidden', !isPinned);
            
            menu.classList.remove('hidden');
            
            // Position menu above the taskbar icon
            const menuHeight = 110;
            menu.style.left = (event.pageX - 75) + 'px';
            menu.style.top = (event.pageY - menuHeight - 8) + 'px';
        }

        function handleContextMenuAction(action) {
            const menu = document.getElementById('taskbar-context-menu');
            menu.classList.add('hidden');
            
            if (action === 'pin') {
                if (!state.pinnedApps.includes(contextMenuAppId)) {
                    state.pinnedApps.push(contextMenuAppId);
                    createDynamicTaskbarIcon(contextMenuAppId);
                }
            } else if (action === 'unpin') {
                state.pinnedApps = state.pinnedApps.filter(id => id !== contextMenuAppId);
                removeDynamicTaskbarIcon(contextMenuAppId);
            } else if (action === 'close') {
                closeWindow(contextMenuAppId);
            }
        }

        function createDynamicTaskbarIcon(appId) {
            const app = apps[appId];
            if (!app || document.querySelector(`.taskbar-icon[data-app-id="${appId}"]`)) return;
            
            const iconContainer = document.querySelector('.taskbar-icon[data-app-id="temu-spotify"]').parentElement;
            const newIcon = document.createElement('div');
            newIcon.className = 'taskbar-icon p-2 rounded';
            newIcon.setAttribute('data-app-id', appId);
            newIcon.setAttribute('onclick', `openApp('${appId}')`);
            newIcon.oncontextmenu = (e) => showContextMenu(e, appId);
            newIcon.innerHTML = `<img src="${app.icon}" class="w-6 h-6">`;
            
            iconContainer.appendChild(newIcon);
        }

        function removeDynamicTaskbarIcon(appId) {
            const icon = document.querySelector(`.taskbar-icon[data-app-id="${appId}"]`);
            if (icon && state.activeApps[appId] === undefined) {
                icon.remove();
            }
        }

        function showWindowContextMenu(event, appId) {
            contextMenuAppId = appId;
            const win = state.activeApps[appId];
            const isUranidiot = appId === 'uranidiot';
            const isPinned = state.pinnedApps.includes(appId);
            
            const menu = document.getElementById('taskbar-context-menu');
            const pinBtn = document.getElementById('context-pin-btn');
            const unpinBtn = document.getElementById('context-unpin-btn');
            const closeBtn = document.getElementById('context-close-btn');
            
            // Show/hide pin/unpin buttons
            pinBtn.classList.toggle('hidden', isPinned);
            unpinBtn.classList.toggle('hidden', !isPinned);
            
            // Hide close button for uranidiot
            closeBtn.classList.toggle('hidden', isUranidiot);
            
            // Position menu at cursor
            menu.classList.remove('hidden');
            menu.style.left = event.pageX + 'px';
            menu.style.top = (event.pageY - 10) + 'px';
        }

        function openApp(id) {
            startMenu.classList.remove('active');
            
            if (state.activeApps[id]) {
                focusWindow(id);
                return;
            }

            const app = apps[id];
            const win = document.createElement('div');
            win.id = `window-${id}`;
            win.className = 'window absolute pointer-events-auto';
            win.style.width = (app.width || 800) + 'px';
            win.style.height = (app.height || 600) + 'px';
            win.style.left = (50 + Object.keys(state.activeApps).length * 30) + 'px';
            win.style.top = (50 + Object.keys(state.activeApps).length * 30) + 'px';
            win.style.zIndex = ++state.zIndex;

            // If app is not pinned and doesn't have a taskbar icon, create one dynamically
            if (!state.pinnedApps.includes(id) && !document.querySelector(`.taskbar-icon[data-app-id="${id}"]`)) {
                createDynamicTaskbarIcon(id);
            }

            // Update taskbar icon
            updateTaskbarIcon(id, 'add');
            updateTaskbarIcon(id, 'focus');

            win.innerHTML = `
                <div class="window-header h-10 flex items-center justify-between px-3 cursor-move">
                    <div class="flex items-center gap-2">
                        <img src="${app.icon}" class="w-4 h-4">
                        <span class="text-xs font-semibold overflow-hidden whitespace-nowrap">${app.title}</span>
                    </div>
                    <div class="flex items-center">
                        <button class="w-10 h-10 hover:bg-black/10 flex items-center justify-center transition-colors" onclick="minimizeWindow('${id}')">
                            <img src="https://img.icons8.com/ios-glyphs/15/null/minus-math.png" class="dark:invert">
                        </button>
                        <button class="w-10 h-10 hover:bg-black/10 flex items-center justify-center transition-colors" onclick="maximizeWindow('${id}')">
                            <img src="https://img.icons8.com/ios-glyphs/15/null/maximize-window.png" class="dark:invert">
                        </button>
                        <button class="w-10 h-10 hover:bg-red-500 hover:text-white flex items-center justify-center transition-colors" onclick="closeWindow('${id}')">
                            <img src="https://img.icons8.com/ios-glyphs/15/null/multiply.png" class="dark:invert group-hover:invert-0">
                        </button>
                    </div>
                </div>
                <div class="window-content flex-1 overflow-hidden">
                    ${app.content}
                </div>
            `;

            windowContainer.appendChild(win);
            state.activeApps[id] = win;
            win.dataset.appId = id;

            // Draggable
            makeDraggable(win, win.querySelector('.window-header'));
            
            // Focus on click
            win.addEventListener('mousedown', () => focusWindow(id));
            
            // Right-click context menu
            win.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showWindowContextMenu(e, id);
            });

            if (app.onMount) app.onMount(win);
        }

        function closeWindow(id) {
            const win = state.activeApps[id];
            if (win) {
                // Prevent closing uncloseable apps
                if (win.dataset.uncloseable === 'true') {
                    showNotification('Cannot Close', 'This application cannot be closed!');
                    return;
                }
                
                win.classList.add('scale-95', 'opacity-0');
                
                // Remove from taskbar
                updateTaskbarIcon(id, 'remove');

                setTimeout(() => {
                    win.remove();
                    delete state.activeApps[id];
                    
                    // If app is not pinned, remove its taskbar icon
                    if (!state.pinnedApps.includes(id)) {
                        const icon = document.querySelector(`.taskbar-icon[data-app-id="${id}"]`);
                        if (icon) icon.remove();
                    }
                }, 150);
            }
        }

        function focusWindow(id) {
            const win = state.activeApps[id];
            if (win) {
                win.classList.remove('hidden-window');
                win.style.zIndex = ++state.zIndex;

                // Update taskbar focus
                updateTaskbarIcon(id, 'focus');
            }
        }

        function minimizeWindow(id) {
            const win = state.activeApps[id];
            if (win) {
                win.classList.add('hidden-window');
                
                // Update taskbar - remove focused but keep open
                const icon = document.querySelector(`.taskbar-icon[data-app-id="${id}"]`);
                if (icon) {
                    icon.classList.remove('focused');
                }
            }
        }

        function maximizeWindow(id) {
            const win = state.activeApps[id];
            if (win) {
                if (win.dataset.maximized === 'true') {
                    win.style.width = win.dataset.oldWidth;
                    win.style.height = win.dataset.oldHeight;
                    win.style.left = win.dataset.oldLeft;
                    win.style.top = win.dataset.oldTop;
                    win.dataset.maximized = 'false';
                    win.classList.remove('rounded-none');
                } else {
                    win.dataset.oldWidth = win.style.width;
                    win.dataset.oldHeight = win.style.height;
                    win.dataset.oldLeft = win.style.left;
                    win.dataset.oldTop = win.style.top;
                    win.style.width = '100%';
                    win.style.height = 'calc(100% - 48px)';
                    win.style.left = '0';
                    win.style.top = '0';
                    win.dataset.maximized = 'true';
                    win.classList.add('rounded-none');
                }
            }
        }

        function makeDraggable(el, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            handle.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                if (el.dataset.maximized === 'true') return;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                el.classList.add('dragging');
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                el.style.top = (el.offsetTop - pos2) + "px";
                el.style.left = (el.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                el.classList.remove('dragging');
            }
        }

        // System Settings
        function setTheme(theme) {
            state.theme = theme;
            if (theme === 'dark') {
                document.body.classList.add('dark');
                document.body.classList.remove('light-theme');
            } else {
                document.body.classList.remove('dark');
                document.body.classList.add('light-theme');
            }
        }

        function setWallpaper(url) {
            // Unpack url from css 'url("...")' format if needed
            const cleanUrl = url.replace('url("', '').replace('")', '');
            state.wallpaper = cleanUrl;
            document.getElementById('desktop').style.backgroundImage = `url("${cleanUrl}")`;
        }

        function setFontSize(val) {
            state.fontSize = val;
            document.documentElement.style.setProperty('--system-font-size', val + 'px');
            const label = document.getElementById('settings-font-val');
            if (label) label.innerText = val + 'px';
        }

        function setTransparency(enabled) {
            state.transparency = enabled;
            const elements = document.querySelectorAll('.taskbar, .start-menu, .window, .window-header');
            elements.forEach(el => {
                if (enabled) el.classList.remove('no-blur');
                else el.classList.add('no-blur');
            });
        }

        function setBrightness(val) {
            state.brightness = val;
            brightnessOverlay.style.opacity = (100 - val) / 100 * 0.7;
            const settingsVal = document.getElementById('settings-brightness-val');
            if (settingsVal) settingsVal.innerText = val + '%';
        }

        function setVolume(val) {
            state.volume = val;
            const settingsVal = document.getElementById('settings-volume-val');
            if (settingsVal) settingsVal.innerText = val + '%';
            
            // Sync Spotify volume if open
            const spotVol = document.getElementById('spotify-vol-bar');
            if (spotVol) spotVol.style.width = val + '%';
        }

        function toggleNightLight(checked) {
            document.getElementById('desktop').style.filter = checked ? 'sepia(0.3) saturate(0.8)' : 'none';
        }

        // System Tray Functions - Action Center
        function showActionCenter() {
            const actionCenter = document.createElement('div');
            actionCenter.className = 'fixed bottom-16 right-4 bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-700 rounded-lg shadow-2xl z-[10000] w-96 max-h-96 overflow-y-auto';
            actionCenter.innerHTML = `
                <div class="p-4 border-b border-gray-200 dark:border-zinc-700">
                    <div class="text-sm font-bold mb-4">Quick Settings</div>
                    <div class="grid grid-cols-4 gap-2 mb-4">
                        <div class="flex flex-col items-center gap-1 p-2 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer" onclick="toggleWifiQuick()">
                            <div class="text-xl">ðŸ“¡</div>
                            <div class="text-xs text-center">Wi-Fi</div>
                        </div>
                        <div class="flex flex-col items-center gap-1 p-2 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer" onclick="toggleBluetoothQuick()">
                            <div class="text-xl">ðŸ”µ</div>
                            <div class="text-xs text-center">Bluetooth</div>
                        </div>
                        <div class="flex flex-col items-center gap-1 p-2 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer" onclick="toggleAirplaneQuick()">
                            <div class="text-xl">âœˆï¸</div>
                            <div class="text-xs text-center">Airplane</div>
                        </div>
                        <div class="flex flex-col items-center gap-1 p-2 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer" onclick="toggleBrightnessQuick()">
                            <div class="text-xl">ðŸ”†</div>
                            <div class="text-xs text-center">Brightness</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="flex flex-col items-center gap-1 p-2 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer" onclick="toggleNightLightQuick()">
                            <div class="text-xl">ðŸŒ™</div>
                            <div class="text-xs text-center">Night Light</div>
                        </div>
                        <div class="flex flex-col items-center gap-1 p-2 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer" onclick="showFocusMode()">
                            <div class="text-xl">ðŸŽ¯</div>
                            <div class="text-xs text-center">Focus</div>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div class="text-sm font-bold mb-3">Notifications</div>
                    <div class="space-y-2">
                        <div class="p-2 bg-gray-50 dark:bg-zinc-800 rounded text-xs">
                            <div class="font-semibold">Windows Update</div>
                            <div class="opacity-70">Update available</div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(actionCenter);
            setTimeout(() => actionCenter.remove(), 5000);
        }

        function toggleWifiQuick() {
            state.wifi.enabled = !state.wifi.enabled;
            updateNetworkUI();
            showNotification('Wi-Fi', state.wifi.enabled ? 'Wi-Fi enabled' : 'Wi-Fi disabled');
        }

        function toggleBluetoothQuick() {
            showNotification('Bluetooth', 'Bluetooth toggled');
        }

        function toggleAirplaneQuick() {
            showNotification('Airplane Mode', 'Airplane mode toggled');
        }

        function toggleBrightnessQuick() {
            setBrightness(state.brightness === 100 ? 50 : 100);
        }

        function toggleNightLightQuick() {
            const desktop = document.getElementById('desktop');
            desktop.style.filter = desktop.style.filter === 'none' ? 'sepia(0.3) saturate(0.8)' : 'none';
            showNotification('Night Light', 'Night Light toggled');
        }

        function showFocusMode() {
            showNotification('Focus Assist', 'Focus mode enabled - Priority notifications only');
        }

        function toggleWifiPanel() {
            openApp('settings');
        }

        function toggleVolumeControl() {
            const newVolume = prompt('Set volume (0-100):', state.volume);
            if (newVolume !== null && !isNaN(newVolume)) {
                const vol = Math.max(0, Math.min(100, parseInt(newVolume)));
                setVolume(vol);
                showNotification('Volume', vol + '%');
            }
        }

        function showBatteryStatus() {
            const charging = state.battery.charging ? 'Charging' : 'Not charging';
            showNotification('Battery Status', `${state.battery.level}% - ${charging}`);
        }

        // Initialize Drag Preview Icon
        const dragIconPreview = document.createElement('img');
        dragIconPreview.id = 'drag-icon-preview';
        dragIconPreview.className = 'fixed pointer-events-none z-[10004] w-8 h-8 opacity-50 hidden';
        document.body.appendChild(dragIconPreview);

        // Desktop Rendering
        const dragPreview = document.createElement('div');
        dragPreview.id = 'drag-preview-label';
        dragPreview.className = 'fixed pointer-events-none z-[10005] bg-blue-600 text-white px-2 py-1 rounded text-[10px] hidden shadow-lg flex items-center gap-2';
        dragPreview.innerHTML = '<span>Move to Desktop</span>';
        document.body.appendChild(dragPreview);

        function updateDragPreview(e, text, visible = true, icon = null) {
            if (!visible) {
                dragPreview.classList.add('hidden');
                dragIconPreview.classList.add('hidden');
                return;
            }
            dragPreview.classList.remove('hidden');
            dragPreview.style.left = (e.clientX + 10) + 'px';
            dragPreview.style.top = (e.clientY + 20) + 'px';
            dragPreview.querySelector('span').innerText = text;

            if (icon) {
                dragIconPreview.src = icon;
                dragIconPreview.classList.remove('hidden');
                dragIconPreview.style.left = (e.clientX - 16) + 'px';
                dragIconPreview.style.top = (e.clientY - 16) + 'px';
            } else {
                dragIconPreview.classList.add('hidden');
            }
        }

        function renderDesktopIcons() {
            const container = document.getElementById('desktop-icons-container');
            const desktopContent = fileSystem['Desktop'].children;
            container.innerHTML = '';
            
            // Grid settings
            const gridSize = 100;
            let col = 0;
            let row = 0;
            const maxRows = Math.floor((window.innerHeight - 60) / gridSize);

            desktopContent.forEach((name) => {
                const isFile = fileSystem[name]?.type === 'file';
                const isApp = fileSystem[name]?.type === 'app';
                
                let iconUrl;
                if (isFile) {
                    iconUrl = name.endsWith('.txt') ? 'https://img.icons8.com/color/96/notepad.png' : 'https://img.icons8.com/color/96/file.png';
                } else if (name === 'Browser') {
                    iconUrl = 'https://upload.wikimedia.org/wikipedia/commons/9/98/Microsoft_Edge_logo_%282019%29.svg';
                } else if (name === 'This PC') {
                    iconUrl = 'https://img.icons8.com/color/96/monitor--v1.png';
                } else if (name === 'Recycle Bin') {
                    const isEmpty = fileSystem['Recycle Bin'].children.length === 0;
                    iconUrl = isEmpty ? 'https://img.icons8.com/color/96/trash--v1.png' : 'https://img.icons8.com/color/96/full-trash.png';
                } else {
                    iconUrl = 'https://img.icons8.com/color/96/folder-invoices--v1.png';
                }

                const div = document.createElement('div');
                div.className = `desktop-icon flex flex-col items-center p-2 rounded cursor-pointer group pointer-events-auto ${isApp ? 'is-app' : ''}`;
                div.style.position = 'absolute';
                div.style.top = (row * gridSize + 10) + 'px';
                div.style.left = (col * gridSize + 10) + 'px';
                
                // Double click behavior
                if (name === 'This PC') div.ondblclick = () => openApp('this-pc');
                else if (name === 'Recycle Bin') {
                    div.ondblclick = () => openApp('recycle-bin');
                    div.ondragover = (e) => handleFileDragOver(e);
                    div.ondrop = (e) => handleFileDrop(e, 'Recycle Bin');
                }
                else if (name === 'Browser') div.ondblclick = () => openApp('edge');
                else if (isFile) div.ondblclick = () => openFile(name);
                else div.ondblclick = () => navigateExplorerTo(name);

                div.innerHTML = `
                    <img src="${iconUrl}" class="w-12 h-12 drop-shadow-lg pointer-events-none">
                    <span class="text-white text-[11px] mt-1 text-center drop-shadow-md group-hover:drop-shadow-none pointer-events-none">${name}</span>
                `;
                
                container.appendChild(div);
                
                row++;
                if (row >= maxRows) {
                    row = 0;
                    col++;
                }
            });

            initDesktopDragging();
        }

        // Explorer Functions
        function updateExplorerUI(win = document.getElementById('window-this-pc')) {
            if (!win) return;
            const currentFolder = state.explorer.path[state.explorer.path.length - 1];
            const folderData = fileSystem[currentFolder];
            
            // Update Breadcrumbs
            const breadcrumbs = win.querySelector('#explorer-breadcrumbs');
            if (breadcrumbs) {
                breadcrumbs.innerHTML = state.explorer.path.map((p, i) => `
                    <span class="hover:bg-gray-100 dark:hover:bg-zinc-800 px-1 rounded cursor-pointer" onclick="navigateExplorerToIndex(${i})">${p}</span>
                    ${i < state.explorer.path.length - 1 ? '<span class="opacity-40">></span>' : ''}
                `).join('');
            }

            // Update Navigation Buttons
            const backBtn = win.querySelector('#explorer-back');
            const forwardBtn = win.querySelector('#explorer-forward');
            if (backBtn) backBtn.disabled = state.explorer.historyIndex <= 0;
            if (forwardBtn) forwardBtn.disabled = state.explorer.historyIndex >= state.explorer.history.length - 1;

            // Update Grid
            const grid = win.querySelector('#explorer-grid');
            if (grid) {
                if (!folderData || !folderData.children || folderData.children.length === 0) {
                    grid.innerHTML = '<div class="h-full flex items-center justify-center text-gray-400 text-xs italic">This folder is empty.</div>';
                } else {
                    grid.innerHTML = `
                        <div class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4">
                            ${folderData.children.map(name => {
                                const isFile = fileSystem[name]?.type === 'file';
                                const icon = isFile ? 
                                    (name.endsWith('.txt') ? 'https://img.icons8.com/color/48/notepad.png' : 'https://img.icons8.com/color/48/file.png') : 
                                    (name === 'C: Drive' ? 'https://img.icons8.com/color/48/hard-drive.png' : 'https://img.icons8.com/color/48/folder-invoices--v1.png');
                                
                                return `
                                    <div class="flex flex-col items-center gap-1 p-2 hover:bg-blue-100/50 dark:hover:bg-blue-900/20 rounded cursor-pointer group border border-transparent hover:border-blue-300/50 explorer-item" 
                                         draggable="true"
                                         ondragstart="handleFileDragStart(event, '${name}')"
                                         ${!isFile ? `ondragover="handleFileDragOver(event)" ondrop="handleFileDrop(event, '${name}')"` : ''}
                                         ondblclick="${isFile ? `openFile('${name}')` : `navigateExplorerTo('${name}')`}">
                                        <img src="${icon}" class="w-10 h-10 pointer-events-none">
                                        <span class="text-[11px] text-center break-all line-clamp-2 pointer-events-none">${name}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
            }
        }

        // Drag and Drop Implementation
        window.handleFileDragStart = (e, name) => {
            e.dataTransfer.setData('text/plain', name);
            const currentFolder = state.explorer.path[state.explorer.path.length - 1];
            e.dataTransfer.setData('source-folder', currentFolder);
            
            const isFile = fileSystem[name]?.type === 'file';
            const icon = isFile ? 
                (name.endsWith('.txt') ? 'https://img.icons8.com/color/48/notepad.png' : 'https://img.icons8.com/color/48/file.png') : 
                'https://img.icons8.com/color/48/folder-invoices--v1.png';
            
            updateDragPreview(e, `Move to ${currentFolder}`, true, icon);
        };

        window.handleFileDragOver = (e) => {
            e.preventDefault();
            const target = e.target.closest('.explorer-item, .explorer-sidebar-item');
            const explorerContainer = e.target.closest('.explorer-container');
            const desktopContainer = e.target.closest('#desktop-icons-container');
            
            let text = "Move";
            
            if (target) {
                target.classList.add('drag-over');
                const targetName = target.innerText.split('\n')[0].trim();
                text = `Move to ${targetName}`;
            } else if (explorerContainer) {
                const currentFolder = state.explorer.path[state.explorer.path.length - 1];
                text = `Move to ${currentFolder}`;
            } else if (desktopContainer) {
                text = "Move to Desktop";
            }
            
            updateDragPreview(e, text, true);
        };

        window.handleFileDrop = (e, destName) => {
            e.preventDefault();
            updateDragPreview(e, "", false);
            const target = e.target.closest('.explorer-item, .explorer-sidebar-item');
            if (target) target.classList.remove('drag-over');

            const fileName = e.dataTransfer.getData('text/plain');
            const sourceFolder = e.dataTransfer.getData('source-folder');

            if (!fileName) return;

            // Block drops into apps like Browser
            if (fileSystem[destName]?.type === 'app') {
                showNotification('Action Blocked', `Cannot move files to ${destName}.`);
                return;
            }

            if (fileName === destName || !fileSystem[destName] || fileSystem[destName].type === 'file') return;

            // Remove from source
            if (fileSystem[sourceFolder]) {
                fileSystem[sourceFolder].children = fileSystem[sourceFolder].children.filter(c => c !== fileName);
            }

            // Add to destination
            if (!fileSystem[destName].children.includes(fileName)) {
                fileSystem[destName].children.push(fileName);
            }

            // Refresh UI
            renderDesktopIcons();
            renderRecycleBin();
            updateExplorerUI();
            showNotification('Explorer', `Moved ${fileName} to ${destName}`);
        };

        // Listen for global dragleave to clean up styles
        document.addEventListener('dragleave', (e) => {
            const target = e.target.closest('.explorer-item, .explorer-sidebar-item');
            if (target) target.classList.remove('drag-over');
        });

        // Initialize Desktop Icon Dragging
        function initDesktopDragging() {
            const icons = document.querySelectorAll('.desktop-icon');
            const recycleBinIcon = Array.from(icons).find(icon => icon.textContent.includes('Recycle Bin'));
            const edgeIcon = Array.from(icons).find(icon => icon.textContent.includes('Browser'));
            const gridSize = 100;

            icons.forEach(icon => {
                if (icon.dataset.isDraggingInitialized) return;
                icon.dataset.isDraggingInitialized = 'true';

                icon.onmousedown = (e) => {
                    if (e.button !== 0) return;
                    
                    const rect = icon.getBoundingClientRect();
                    const offsetX = e.clientX - rect.left;
                    const offsetY = e.clientY - rect.top;
                    const originalZIndex = icon.style.zIndex;
                    
                    icon.style.zIndex = 10000;
                    
                    const moveAt = (pageX, pageY) => {
                        icon.style.left = (pageX - offsetX) + 'px';
                        icon.style.top = (pageY - offsetY) + 'px';
                    };

                    const onMouseMove = (ev) => {
                        moveAt(ev.pageX, ev.pageY);
                        
                        let text = "Move to Desktop";
                        const fileName = icon.querySelector('span').innerText;
                        
                        // Important: Check virtual file system for the real type
                        const isFile = fileSystem[fileName]?.type === 'file';
                        const dragIcon = isFile ? 
                            (fileName.endsWith('.txt') ? 'https://img.icons8.com/color/48/notepad.png' : 'https://img.icons8.com/color/48/file.png') : 
                            (fileName === 'Browser' ? 'https://img.icons8.com/color/48/microsoft-edge.png' : 
                             fileName === 'This PC' ? 'https://img.icons8.com/color/48/monitor--v1.png' :
                             'https://img.icons8.com/color/48/folder-invoices--v1.png');

                        // Check targets for preview
                        if (recycleBinIcon && icon !== recycleBinIcon) {
                            const binRect = recycleBinIcon.getBoundingClientRect();
                            if (!(ev.clientX < binRect.left || ev.clientX > binRect.right || ev.clientY < binRect.top || ev.clientY > binRect.bottom)) {
                                text = "Move to Recycle Bin";
                            }
                        }

                        // Block Edge
                        if (edgeIcon && icon !== edgeIcon) {
                            const edgeRect = edgeIcon.getBoundingClientRect();
                            if (!(ev.clientX < edgeRect.left || ev.clientX > edgeRect.right || ev.clientY < edgeRect.top || ev.clientY > edgeRect.bottom)) {
                                text = "Action Blocked (Edge)";
                            }
                        }
                        
                        updateDragPreview(ev, text, true, dragIcon);
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    
                    const onMouseUp = (ev) => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        updateDragPreview(ev, "", false);
                        
                        icon.style.zIndex = originalZIndex;

                        // Grid Snapping Logic
                        let currentLeft = parseInt(icon.style.left);
                        let currentTop = parseInt(icon.style.top);
                        
                        let snappedLeft = Math.floor(currentLeft / gridSize) * gridSize + 10;
                        let snappedTop = Math.floor(currentTop / gridSize) * gridSize + 10;

                        icon.style.left = snappedLeft + 'px';
                        icon.style.top = snappedTop + 'px';

                        // Recycle Bin Check
                        if (recycleBinIcon && icon !== recycleBinIcon) {
                            const binRect = recycleBinIcon.getBoundingClientRect();
                            const iconRect = icon.getBoundingClientRect();
                            const isOverlapping = !(iconRect.right < binRect.left || iconRect.left > binRect.right || iconRect.bottom < binRect.top || iconRect.top > binRect.bottom);

                            if (isOverlapping) {
                                const fileName = icon.querySelector('span').innerText;
                                // Add to Recycle Bin if not already there
                                if (!fileSystem['Recycle Bin'].children.includes(fileName)) {
                                    fileSystem['Recycle Bin'].children.push(fileName);
                                }
                                // Remove from source (Desktop)
                                fileSystem['Desktop'].children = fileSystem['Desktop'].children.filter(c => c !== fileName);
                                
                                renderDesktopIcons();
                                // Force refresh Recycle Bin window if open
                                const rbWin = document.getElementById('window-recycle-bin');
                                if (rbWin) renderRecycleBin(rbWin);
                                
                                showNotification('Recycle Bin', `${fileName} moved to Recycle Bin.`);
                            }
                        }
                    };

                    document.addEventListener('mouseup', onMouseUp);
                };
                
                icon.ondragstart = () => false;
            });
        }

        window.navigateExplorerTo = (folderName) => {
            if (fileSystem[folderName]?.type === 'file') return;
            
            // Simple logic: if it's a root shortcut, reset path. If it's a subfolder of current, append.
            // For this demo, let's just jump to it if it exists in fileSystem.
            if (fileSystem[folderName]) {
                state.explorer.path = [folderName]; 
                // In a real OS, it would build the path. Here we simplify.
                if (folderName === 'This PC') state.explorer.path = ['This PC'];
                else if (['Documents', 'Downloads', 'Pictures', 'Music', 'Videos'].includes(folderName)) {
                    state.explorer.path = ['This PC', folderName];
                }

                // Update history
                state.explorer.history = state.explorer.history.slice(0, state.explorer.historyIndex + 1);
                state.explorer.history.push([...state.explorer.path]);
                state.explorer.historyIndex++;
                
                updateExplorerUI();
            }
        };

        window.navigateExplorerBack = () => {
            if (state.explorer.historyIndex > 0) {
                state.explorer.historyIndex--;
                state.explorer.path = [...state.explorer.history[state.explorer.historyIndex]];
                updateExplorerUI();
            }
        };

        window.navigateExplorerForward = () => {
            if (state.explorer.historyIndex < state.explorer.history.length - 1) {
                state.explorer.historyIndex++;
                state.explorer.path = [...state.explorer.history[state.explorer.historyIndex]];
                updateExplorerUI();
            }
        };

        window.navigateExplorerUp = () => {
            if (state.explorer.path.length > 1) {
                state.explorer.path.pop();
                
                state.explorer.history = state.explorer.history.slice(0, state.explorer.historyIndex + 1);
                state.explorer.history.push([...state.explorer.path]);
                state.explorer.historyIndex++;
                
                updateExplorerUI();
            }
        };

        window.navigateExplorerToIndex = (index) => {
            state.explorer.path = state.explorer.path.slice(0, index + 1);
            state.explorer.history = state.explorer.history.slice(0, state.explorer.historyIndex + 1);
            state.explorer.history.push([...state.explorer.path]);
            state.explorer.historyIndex++;
            updateExplorerUI();
        };

        window.openFile = (fileName) => {
            const file = fileSystem[fileName];
            if (file && fileName.endsWith('.txt')) {
                openApp('notepad');
                setTimeout(() => {
                    const notepadWin = document.getElementById('window-notepad');
                    if (notepadWin) {
                        notepadWin.querySelector('textarea').value = file.content;
                        notepadWin.querySelector('.window-header span').innerText = `${fileName} - Notepad`;
                        notepadWin.dataset.fileName = fileName;
                    }
                }, 100);
            } else {
                alert(`Opening ${fileName}... (No associated app found)`);
            }
        };

        // Recycle Bin Functions
        window.renderRecycleBin = (win = document.getElementById('window-recycle-bin')) => {
            if (!win) return;
            const grid = win.querySelector('#recycle-bin-grid');
            const items = fileSystem['Recycle Bin'].children;

            if (items.length === 0) {
                grid.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-gray-400 text-xs italic gap-4">
                        <img src="https://img.icons8.com/color/96/trash--v1.png" class="opacity-20 grayscale">
                        Your Recycle Bin is empty.
                    </div>`;
                return;
            }

            grid.innerHTML = `
                <div class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4">
                    ${items.map(name => {
                        const isFile = fileSystem[name]?.type === 'file';
                        const icon = isFile ? 
                            (name.endsWith('.txt') ? 'https://img.icons8.com/color/48/notepad.png' : 'https://img.icons8.com/color/48/file.png') : 
                            'https://img.icons8.com/color/48/folder-invoices--v1.png';
                        
                        return `
                            <div class="flex flex-col items-center gap-1 p-2 hover:bg-blue-100/50 dark:hover:bg-blue-900/20 rounded group border border-transparent relative">
                                <img src="${icon}" class="w-10 h-10 pointer-events-none opacity-60">
                                <span class="text-[11px] text-center break-all line-clamp-2 pointer-events-none opacity-60">${name}</span>
                                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-white/40 dark:bg-black/40 backdrop-blur-[2px] rounded transition-opacity gap-1">
                                    <button onclick="restoreFile('${name}')" title="Restore" class="p-1 hover:bg-white dark:hover:bg-zinc-800 rounded shadow-sm border border-gray-200 dark:border-zinc-700">
                                        <img src="https://img.icons8.com/color/16/undo.png">
                                    </button>
                                    <button onclick="permanentlyDelete('${name}')" title="Delete Permanently" class="p-1 hover:bg-red-500 rounded shadow-sm border border-gray-200 dark:border-zinc-700">
                                        <img src="https://img.icons8.com/ios-glyphs/16/ffffff/multiply.png">
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        };

        window.emptyRecycleBin = () => {
            if (fileSystem['Recycle Bin'].children.length === 0) return;
            if (confirm('Are you sure you want to permanently delete all items in the Recycle Bin?')) {
                fileSystem['Recycle Bin'].children.forEach(name => {
                    delete fileSystem[name];
                });
                fileSystem['Recycle Bin'].children = [];
                renderRecycleBin();
                showNotification('Recycle Bin', 'Recycle Bin emptied.');
            }
        };

        window.restoreFile = (name) => {
            fileSystem['Recycle Bin'].children = fileSystem['Recycle Bin'].children.filter(c => c !== name);
            if (!fileSystem['Desktop'].children.includes(name)) {
                fileSystem['Desktop'].children.push(name);
            }
            renderRecycleBin();
            renderDesktopIcons();
            showNotification('Recycle Bin', `${name} restored to Desktop.`);
        };

        window.permanentlyDelete = (name) => {
            if (confirm(`Permanently delete ${name}?`)) {
                fileSystem['Recycle Bin'].children = fileSystem['Recycle Bin'].children.filter(c => c !== name);
                delete fileSystem[name];
                renderRecycleBin();
                showNotification('Recycle Bin', `${name} deleted permanently.`);
            }
        };

        // Notepad Actions
        window.notepadNew = (el) => {
            const win = el.closest('.window');
            const textarea = win.querySelector('textarea');
            if (textarea.value && !confirm('Discard changes?')) return;
            textarea.value = '';
            win.dataset.fileName = 'Untitled.txt';
            win.querySelector('.window-header span').innerText = 'Untitled - Notepad';
        };

        window.notepadSave = (el) => {
            const win = el.closest('.window');
            const fileName = win.dataset.fileName;
            if (fileName === 'Untitled.txt') {
                notepadSaveAs(el);
            } else {
                saveToSystem(win, fileName);
            }
        };

        window.notepadSaveAs = (el) => {
            const win = el.closest('.window');
            let newName = prompt('Enter filename:', win.dataset.fileName || 'document.txt');
            if (!newName) return;
            if (!newName.endsWith('.txt')) newName += '.txt';
            
            saveToSystem(win, newName);
        };

        window.notepadEditAction = (action, el) => {
            const win = el.closest('.window');
            const textarea = win.querySelector('textarea');
            textarea.focus();

            switch(action) {
                case 'undo': document.execCommand('undo'); break;
                case 'cut': document.execCommand('cut'); break;
                case 'copy': document.execCommand('copy'); break;
                case 'paste': 
                    navigator.clipboard.readText().then(text => {
                        const start = textarea.selectionStart;
                        textarea.value = textarea.value.slice(0, start) + text + textarea.value.slice(textarea.selectionEnd);
                        textarea.selectionStart = textarea.selectionEnd = start + text.length;
                    }).catch(() => {
                        showNotification('Notepad', 'Paste failed. Try Ctrl+V');
                    });
                    break;
                case 'delete':
                    const start = textarea.selectionStart;
                    textarea.value = textarea.value.slice(0, start) + textarea.value.slice(textarea.selectionEnd);
                    textarea.selectionStart = textarea.selectionEnd = start;
                    break;
                case 'selectAll': textarea.select(); break;
                case 'timeDate':
                    const now = new Date();
                    const dateTime = now.toLocaleTimeString() + ' ' + now.toLocaleDateString();
                    const cursor = textarea.selectionStart;
                    textarea.value = textarea.value.slice(0, cursor) + dateTime + textarea.value.slice(textarea.selectionEnd);
                    textarea.selectionStart = textarea.selectionEnd = cursor + dateTime.length;
                    break;
            }
        };

        window.notepadFormatAction = (action, el) => {
            const win = el.closest('.window');
            const textarea = win.querySelector('textarea');
            
            if (action === 'wordWrap') {
                const isWrapped = textarea.style.whiteSpace !== 'pre-wrap';
                textarea.style.whiteSpace = isWrapped ? 'pre-wrap' : 'pre';
                textarea.style.overflowX = isWrapped ? 'hidden' : 'auto';
                win.querySelector('#wrap-check').style.visibility = isWrapped ? 'visible' : 'hidden';
            } else if (action === 'font') {
                alert('Font settings are managed by system accessibility.');
            }
        };

        window.notepadViewAction = (action, el) => {
            const win = el.closest('.window');
            const textarea = win.querySelector('textarea');
            let zoom = parseInt(win.dataset.zoom);

            if (action === 'zoomIn') zoom += 10;
            else if (action === 'zoomOut') zoom = Math.max(20, zoom - 10);
            else if (action === 'zoomRestore') zoom = 100;
            else if (action === 'statusBar') {
                const bar = win.querySelector('#notepad-status-bar');
                const isHidden = bar.classList.contains('hidden');
                bar.classList.toggle('hidden');
                win.querySelector('#status-check').style.visibility = isHidden ? 'visible' : 'hidden';
                return;
            }

            win.dataset.zoom = zoom;
            textarea.style.fontSize = (0.875 * (zoom/100)) + 'rem';
            win.querySelectorAll('#notepad-status-bar span')[1].innerText = zoom + '%';
        };

        window.notepadHelpAction = (action, el) => {
            if (action === 'about') {
                showNotification('About Notepad', 'Windows 11 Online Notepad\nVersion 1.0 (Demo Build)\nÂ© 2024 Microsoft Clone.');
            } else if (action === 'viewHelp') {
                window.open('https://www.bing.com/search?q=get+help+with+notepad+in+windows+10', '_blank');
            } else {
                showNotification('Feedback', 'Thank you for your feedback! This simulated environment helps us improve.');
            }
        };

        function saveToSystem(win, fileName) {
            const content = win.querySelector('textarea').value;
            
            // Save to virtual File System
            fileSystem[fileName] = { type: 'file', content: content };
            
            // Add to Documents if not already there
            if (!fileSystem['Documents'].children.includes(fileName)) {
                fileSystem['Documents'].children.push(fileName);
            }
            
            // Update UI
            win.dataset.fileName = fileName;
            win.querySelector('.window-header span').innerText = `${fileName} - Notepad`;
            updateExplorerUI();
            
            // Real browser download
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Notepad', `Saved ${fileName} to virtual system and downloaded to disk.`);
        }

        function showNotification(title, message) {
            // Simplified notification for this specific helper
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 p-4 rounded-lg shadow-xl z-[10002] animate-bounce';
            toast.innerHTML = `<div class="font-bold text-xs">${title}</div><div class="text-[11px] opacity-70">${message}</div>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Spotify Functions
        window.spotifyTogglePlay = (btn) => {
            const win = btn.closest('.window');
            const icon = btn.querySelector('#spotify-play-icon');
            if (win.dataset.isPlaying === 'true') {
                win.dataset.isPlaying = 'false';
                icon.src = 'https://img.icons8.com/material-rounded/24/000000/play--v1.png';
            } else {
                win.dataset.isPlaying = 'true';
                icon.src = 'https://img.icons8.com/material-rounded/24/000000/pause--v1.png';
            }
        };

        window.spotifySeek = (e, bar) => {
            const win = bar.closest('.window');
            const rect = bar.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const width = rect.width;
            const percent = x / width;
            win.dataset.currentTime = Math.floor(percent * parseInt(win.dataset.duration));
            win.querySelector('#spotify-progress').style.width = (percent * 100) + '%';
        };

        // Network Functions
        function syncBrowserConnectivity(win = null) {
            const isOnline = state.wifi.enabled && state.wifi.connectedTo;
            const browsers = win ? [win] : Object.values(state.activeApps).filter(w => w.id === 'window-edge');
            
            browsers.forEach(browserWin => {
                const viewport = browserWin.querySelector('.browser-viewport');
                if (!viewport) return;

                if (isOnline) {
                    viewport.innerHTML = `
                        <div class="p-8 flex flex-col items-center justify-center text-center">
                            <h1 class="text-3xl font-bold mb-4">Welcome to Edge</h1>
                            <p class="text-gray-500 mb-8 max-w-md text-sm">Experience the best of the web with built-in features to help you save time and stay focused.</p>
                            <div class="flex justify-center w-full">
                                <a href="https://test-with-dice111.vercel.app/" target="_blank" class="flex flex-col items-center gap-4 p-8 hover:bg-gray-100 dark:hover:bg-zinc-800 rounded-2xl cursor-pointer transition-all border border-transparent hover:border-blue-500/30 group">
                                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-3xl flex items-center justify-center text-white text-5xl shadow-xl group-hover:scale-110 transition-transform">ðŸŽ²</div>
                                    <div class="text-center">
                                        <div class="text-lg font-bold">Dice Roller Game</div>
                                        <div class="text-xs opacity-60">test-with-dice111.vercel.app</div>
                                    </div>
                                </a>
                            </div>
                            <button onclick="triggerVirusPrank(this)" class="mt-12 bg-blue-600 text-white px-6 py-2 rounded-full text-sm hover:bg-blue-700 transition-colors">Speed up PC (FREE)</button>
                        </div>
                    `;
                } else {
                    viewport.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-center p-8 bg-white dark:bg-zinc-900">
                            <div class="mb-6 bg-gray-100 dark:bg-zinc-800 p-8 rounded-full">
                                <img src="https://img.icons8.com/ios/100/71717a/wi-fi.png" class="w-24 h-24 opacity-50 grayscale dark:invert">
                            </div>
                            <h2 class="text-2xl font-bold mb-2">No internet</h2>
                            <p class="text-gray-500 text-sm mb-6 max-w-xs">Your PC is not connected to the internet. Check your network settings and try again.</p>
                            <button onclick="openApp('settings')" class="px-6 py-2 bg-blue-600 text-white rounded-full text-sm hover:bg-blue-700 transition-colors">Go to Settings</button>
                        </div>
                    `;
                }
            });
        }

        function updateNetworkUI(win = document) {
            const wifiName = win.querySelector('#wifi-name-display');
            const wifiStatus = win.querySelector('#wifi-connected-status');
            const toggleBtn = win.querySelector('#wifi-toggle-btn');
            const networksList = win.querySelector('#wifi-networks-list');
            const taskbarIcon = document.getElementById('taskbar-wifi-icon');
            const statusIcon = win.querySelector('#wifi-status-icon');

            // Update all open browsers whenever network UI changes
            syncBrowserConnectivity();

            if (!wifiName) return;

            if (state.wifi.enabled && state.wifi.connectedTo) {
                wifiName.innerText = state.wifi.connectedTo;
                wifiStatus.innerText = 'Connected, secured';
                wifiStatus.className = 'text-xs text-green-500 font-semibold';
                toggleBtn.innerText = 'Disconnect';
                toggleBtn.className = 'bg-gray-200 dark:bg-zinc-700 hover:bg-gray-300 dark:hover:bg-zinc-600 px-4 py-1 rounded text-sm font-medium transition-colors';
                taskbarIcon.src = 'https://img.icons8.com/ios-glyphs/30/null/wi-fi.png';
                if (statusIcon) statusIcon.src = 'https://img.icons8.com/ios-glyphs/60/0067c0/wi-fi.png';
            } else if (state.wifi.enabled) {
                wifiName.innerText = 'Not connected';
                wifiStatus.innerText = 'Available networks found';
                wifiStatus.className = 'text-xs text-blue-500 font-semibold';
                toggleBtn.innerText = 'Turn Off';
                toggleBtn.className = 'bg-blue-600 text-white px-4 py-1 rounded text-sm font-medium transition-colors';
                taskbarIcon.src = 'https://img.icons8.com/ios-glyphs/30/null/wi-fi.png';
                if (statusIcon) statusIcon.src = 'https://img.icons8.com/ios-glyphs/60/71717a/wi-fi.png';
            } else {
                wifiName.innerText = 'Wi-Fi is off';
                wifiStatus.innerText = 'Turn on to see available networks';
                wifiStatus.className = 'text-xs text-gray-500 font-semibold';
                toggleBtn.innerText = 'Turn On';
                toggleBtn.className = 'bg-blue-600 text-white px-4 py-1 rounded text-sm font-medium transition-colors';
                taskbarIcon.src = 'https://img.icons8.com/ios-glyphs/30/null/disconnected-indicator.png';
                if (statusIcon) statusIcon.src = 'https://img.icons8.com/ios-glyphs/60/71717a/wi-fi.png';
            }

            // Update list
            if (networksList) {
                networksList.innerHTML = '';
                if (state.wifi.enabled) {
                    state.wifi.networks.forEach(net => {
                        const isConnected = state.wifi.connectedTo === net.name;
                        const item = document.createElement('div');
                        item.className = `flex items-center justify-between p-3 rounded hover:bg-white dark:hover:bg-zinc-800 cursor-pointer transition-colors ${isConnected ? 'bg-white dark:bg-zinc-800 ring-1 ring-blue-500' : ''}`;
                        item.onclick = () => connectToWifi(net.name);
                        item.innerHTML = `
                            <div class="flex items-center gap-3">
                                <img src="https://img.icons8.com/ios-glyphs/30/71717a/wi-fi.png" class="w-4 h-4 dark:invert opacity-60">
                                <div>
                                    <div class="text-xs font-semibold">${net.name}</div>
                                    <div class="text-[10px] opacity-60">${net.secure ? 'Secured' : 'Open'}</div>
                                </div>
                            </div>
                            ${isConnected ? '<span class="text-[10px] font-bold text-blue-500">Connected</span>' : ''}
                        `;
                        networksList.appendChild(item);
                    });
                } else {
                    networksList.innerHTML = '<div class="text-center p-8 opacity-40 text-xs italic">Wi-Fi is disabled</div>';
                }
            }
        }

        function toggleWifi() {
            if (state.wifi.connectedTo) {
                state.wifi.connectedTo = null;
            } else {
                state.wifi.enabled = !state.wifi.enabled;
            }
            updateNetworkUI();
            // Also find settings window if open
            const settingsWin = document.getElementById('window-settings');
            if (settingsWin) updateNetworkUI(settingsWin);
        }

        function connectToWifi(name) {
            if (!state.wifi.enabled) return;
            state.wifi.connectedTo = name;
            updateNetworkUI();
            const settingsWin = document.getElementById('window-settings');
            if (settingsWin) updateNetworkUI(settingsWin);
        }

        // Prank Feature
        function triggerVirusPrank(btn) {
            const overlay = document.createElement('div');
            overlay.id = 'prank-overlay';
            overlay.className = 'fixed inset-0 z-[20000] bg-red-600 text-white p-12 flex flex-col items-center justify-center text-center animate-pulse';
            overlay.innerHTML = `
                <img src="https://img.icons8.com/ios-filled/100/ffffff/error.png" class="mb-6">
                <h1 class="text-4xl font-bold mb-4">CRITICAL SYSTEM FAILURE</h1>
                <p class="text-xl mb-8">Malware detected in System32. Encrypting personal files...</p>
                <div class="w-full max-w-md bg-white/20 h-4 rounded-full overflow-hidden mb-4">
                    <div id="virus-progress" class="bg-yellow-400 h-full w-0 transition-all duration-[5000ms] ease-linear"></div>
                </div>
                <p id="virus-status" class="font-mono text-sm">Deleting Photos...</p>
                <div class="mt-12 p-4 border-2 border-dashed border-white rounded animate-bounce">
                    CALL SUPPORT NOW: +1-800-VIRUS-LOL
                </div>
            `;
            document.body.appendChild(overlay);

            // Attempt to trigger real fullscreen if supported
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => {});
            }

            setTimeout(() => {
                const progress = overlay.querySelector('#virus-progress');
                if (progress) progress.style.width = '100%';
                
                const statuses = ['Deleting Documents...', 'Stealing Passwords...', 'Uploading Browser History...', 'Formatting C:/ Drive...', 'Sending spam to contacts...'];
                let i = 0;
                const statusInterval = setInterval(() => {
                    const statusEl = overlay.querySelector('#virus-status');
                    if (statusEl && i < statuses.length) {
                        statusEl.innerText = statuses[i++];
                    } else {
                        clearInterval(statusInterval);
                    }
                }, 1000);
            }, 100);

            setTimeout(() => {
                overlay.className = 'fixed inset-0 z-[20000] bg-[#0078d7] text-white p-12 flex flex-col items-center justify-center text-center';
                overlay.classList.remove('animate-pulse');
                overlay.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-center max-w-4xl">
                        <h1 class="text-9xl mb-8 self-start">:(</h1>
                        <p class="text-2xl mb-4 text-left">Your PC ran into a problem and needs to restart. We're just collecting some error info, and then we'll restart for you.</p>
                        <p class="text-sm opacity-70 mb-12 text-left">100% complete</p>
                        <div class="flex gap-8 items-center text-left">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=gotcha" class="w-32 h-32 border-4 border-white">
                            <div class="text-left text-xs space-y-2">
                                <p>For more information about this issue and possible fixes, visit https://www.windows.com/stopcode</p>
                                <p>If you call a support person, give them this info:</p>
                                <p class="font-bold">Stop code: CRITICAL_PROCESS_DIED</p>
                            </div>
                        </div>
                        <button id="restart-prank-btn" class="mt-12 bg-white text-[#0078d7] px-8 py-2 rounded text-sm font-bold hover:bg-gray-100 transition-colors">Restart Now</button>
                    </div>
                `;
                
                document.getElementById('restart-prank-btn').onclick = () => {
                    overlay.remove();
                    if (document.exitFullscreen) {
                        document.exitFullscreen().catch(() => {});
                    }
                };
            }, 6000);
        }

        // Alt+F2 State
        let altF2Active = false;
        let altF2Index = 0;
        let altF2Apps = [];
        let altF2Box = null;

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            const isMeta = e.ctrlKey || e.metaKey;
            
            // Win+V - Open this PC (file explorer)
            if (e.key === 'e' && (e.ctrlKey)) {
                e.preventDefault();
                openApp('this-pc');
            }
            // Win+S - Search
            if (e.key === 's' && (e.ctrlKey)) {
                e.preventDefault();
                showNotification('Search', 'Search feature - type to search apps and files');
            }
            // Win+X - Power menu
            if (e.key === 'x' && e.ctrlKey && e.shiftKey) {
                e.preventDefault();
                showPowerMenu();
            }
            // Win+I - Settings
            if (e.key === 'i' && e.ctrlKey && e.shiftKey) {
                e.preventDefault();
                openApp('settings');
            }
            // Win+D - Show/hide desktop
            if (e.key === 'd' && e.ctrlKey && e.shiftKey) {
                e.preventDefault();
                toggleDesktopVisibility();
            }
            // Alt+F2 - Switch to next window (single press)
            if (e.altKey && e.key === 'F2') {
                e.preventDefault();
                const appIds = Object.keys(state.activeApps);
                if (appIds.length === 0) {
                    showNotification('Window Switcher', 'No windows open');
                    return;
                }
                
                // Get current focused window
                const currentFocused = Object.keys(state.activeApps).pop();
                const currentIndex = appIds.indexOf(currentFocused);
                
                // Switch to next window (or first if none focused)
                const nextIndex = currentIndex >= 0 ? (currentIndex + 1) % appIds.length : 0;
                const nextAppId = appIds[nextIndex];
                
                // Show brief visual feedback
                const tempBox = document.createElement('div');
                tempBox.className = 'fixed inset-0 flex items-center justify-center z-[9999]';
                tempBox.style.background = 'rgba(0,0,0,0.6)';
                tempBox.style.pointerEvents = 'none';
                const app = apps[nextAppId];
                tempBox.innerHTML = `
                    <div class="bg-white dark:bg-zinc-900 rounded-2xl p-8 shadow-2xl" style="min-width: 300px;">
                        <div class="flex flex-col items-center gap-3">
                            <img src="${app.icon}" class="w-16 h-16" alt="${app.title}">
                            <div class="text-lg font-semibold text-center dark:text-white">${app.title}</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(tempBox);
                
                // Focus the window
                focusWindow(nextAppId);
                
                // Remove visual feedback after brief delay
                setTimeout(() => tempBox.remove(), 500);
            }
            // F5 - Refresh explorer
            if (e.key === 'F5') {
                const explorer = Object.values(state.activeApps).find(w => w.dataset.appId === 'this-pc');
                if (explorer) {
                    e.preventDefault();
                    updateExplorerUI(explorer);
                    showNotification('Explorer', 'Refreshed');
                }
            }
        });

        // Window Snap Layout (Win+Arrow keys)
        document.addEventListener('keydown', (e) => {
            if (!e.ctrlKey && (e.key === 'ArrowLeft' || e.key === 'ArrowRight' || e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
                // Get the currently focused window
                const focusedId = Object.keys(state.activeApps).pop();
                if (focusedId && e.shiftKey) {
                    const win = state.activeApps[focusedId];
                    if (win) {
                        snapWindow(win, e.key);
                    }
                }
            }
        });

        // Global Copy/Paste/Cut handlers
        document.addEventListener('copy', (e) => {
            // Allow normal copy
            return true;
        });

        document.addEventListener('paste', (e) => {
            // Allow normal paste
            return true;
        });

        // Power Menu
        function showPowerMenu() {
            const menu = document.createElement('div');
            menu.className = 'fixed bottom-16 right-4 bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-700 rounded-lg shadow-2xl z-[10000] overflow-hidden w-64';
            menu.innerHTML = `
                <div class="p-3 space-y-2">
                    <div class="text-xs font-bold text-gray-600 dark:text-gray-400 px-2 py-1">Power Options</div>
                    <button class="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 text-sm flex items-center gap-2" onclick="systemPower('sleep')">
                        <span>ðŸ˜´</span> Sleep
                    </button>
                    <button class="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 text-sm flex items-center gap-2" onclick="systemPower('restart')">
                        <span>ðŸ”„</span> Restart
                    </button>
                    <button class="w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-zinc-800 text-sm flex items-center gap-2" onclick="systemPower('shutdown')">
                        <span>â»ï¸</span> Shut down
                    </button>
                </div>
            `;
            document.body.appendChild(menu);
            setTimeout(() => menu.remove(), 5000);
        }

        function systemPower(action) {
            if (action === 'sleep') {
                showNotification('Power', 'System will sleep in 10 seconds... (Demo)');
            } else if (action === 'restart') {
                showNotification('Power', 'System restarting... (Demo)');
            } else if (action === 'shutdown') {
                showNotification('Power', 'System shutting down... (Demo)');
            }
        }

        // Window Snap Layouts
        function snapWindow(win, direction) {
            const viewport = { width: window.innerWidth, height: window.innerHeight - 48 };
            
            if (direction === 'ArrowLeft') {
                win.style.width = (viewport.width / 2) + 'px';
                win.style.height = viewport.height + 'px';
                win.style.left = '0px';
                win.style.top = '0px';
                win.dataset.snapped = 'left';
            } else if (direction === 'ArrowRight') {
                win.style.width = (viewport.width / 2) + 'px';
                win.style.height = viewport.height + 'px';
                win.style.left = (viewport.width / 2) + 'px';
                win.style.top = '0px';
                win.dataset.snapped = 'right';
            } else if (direction === 'ArrowUp') {
                win.style.width = viewport.width + 'px';
                win.style.height = (viewport.height / 2) + 'px';
                win.style.left = '0px';
                win.style.top = '0px';
                win.dataset.snapped = 'top';
            } else if (direction === 'ArrowDown') {
                win.style.width = viewport.width + 'px';
                win.style.height = (viewport.height / 2) + 'px';
                win.style.left = '0px';
                win.style.top = (viewport.height / 2) + 'px';
                win.dataset.snapped = 'bottom';
            }
            showNotification('Window Snap', 'Window snapped to ' + direction.replace('Arrow', '').toLowerCase());
        }

        // Alt+F2 Window Switcher
        function showAltF2Switcher() {
            altF2Box = document.createElement('div');
            altF2Box.className = 'fixed inset-0 flex items-center justify-center z-[9999]';
            altF2Box.style.background = 'rgba(0,0,0,0.6)';
            altF2Box.style.pointerEvents = 'none';
            updateAltF2Switcher();
            document.body.appendChild(altF2Box);
        }

        function updateAltF2Switcher() {
            if (!altF2Box) return;
            altF2Box.innerHTML = `
                <div class="bg-white dark:bg-zinc-900 rounded-2xl p-8 shadow-2xl" style="min-width: 400px; pointer-events: none;">
                    <div class="grid grid-cols-2 gap-4">
                        ${altF2Apps.map((id, idx) => {
                            const app = apps[id];
                            const isSelected = idx === altF2Index;
                            return `
                                <div class="flex flex-col items-center gap-3 p-4 rounded-lg transition-all ${isSelected ? 'bg-blue-600 dark:bg-blue-700 ring-4 ring-blue-400' : 'bg-gray-100 dark:bg-zinc-800'}">
                                    <img src="${app.icon}" class="w-16 h-16" alt="${app.title}">
                                    <div class="text-sm font-semibold text-center ${isSelected ? 'text-white' : 'dark:text-white'}">${app.title}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="text-center mt-4 text-xs opacity-60">Release Alt to switch</div>
                </div>
            `;
        }

        // Toggle Desktop Visibility
        function toggleDesktopVisibility() {
            const desktop = document.getElementById('desktop');
            if (desktop) {
                desktop.style.display = desktop.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Initialize
        window.onload = () => {
            // Apply initial state
            setTheme(state.theme);
            setWallpaper(state.wallpaper);
            setFontSize(state.fontSize);
            setTransparency(state.transparency);
            setBrightness(state.brightness);
            updateNetworkUI();
            renderDesktopIcons();
            
            // Add right-click context menu to desktop
            document.addEventListener('contextmenu', (e) => {
                if (e.target.id === 'desktop' || e.target.closest('#desktop')) {
                    e.preventDefault();
                    showDesktopContextMenu(e);
                }
            });
        };

        // Desktop Context Menu
        function showDesktopContextMenu(e) {
            const menu = document.createElement('div');
            menu.className = 'fixed bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-700 rounded shadow-xl z-[10001] text-sm w-48';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            menu.innerHTML = `
                <div class="py-1">
                    <div class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer" onclick="refreshDesktop()">ðŸ”„ Refresh</div>
                    <div class="border-t border-gray-200 dark:border-zinc-700"></div>
                    <div class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer" onclick="newFolder()">ðŸ“ New Folder</div>
                    <div class="border-t border-gray-200 dark:border-zinc-700"></div>
                    <div class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer" onclick="openApp('settings')">âš™ï¸ Settings</div>
                    <div class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer" onclick="showNotification('Display Settings', 'Display settings - Change resolution, refresh rate, and more')">ðŸ–¥ï¸ Display Settings</div>
                </div>
            `;
            document.body.appendChild(menu);
            setTimeout(() => menu.remove(), 3000);
        }

        function refreshDesktop() {
            renderDesktopIcons();
            showNotification('Desktop', 'Desktop refreshed');
        }

        function newFolder() {
            showNotification('New Folder', 'New folder created on desktop');
        }

        // Spotify Audio Player Functions
        let spotifyAudioPlayer = null;
        let spotifyCurrentTrack = 0;
        const spotifyTracks = [
            {
                title: 'Song #1',
                artist: 'Track 1',
                url: 'https://open.spotify.com/embed/track/7DQS9dDYhawDeg95jn0xcR',
                cover: 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=300&h=300&fit=crop'
            },
            {
                title: 'Song #2',
                artist: 'Track 2',
                url: 'https://open.spotify.com/embed/track/3YCMYhkGbaHM57t2amoIVi',
                cover: 'https://images.unsplash.com/photo-1493225255756-d9584f8606e9?w=300&h=300&fit=crop'
            },
            {
                title: 'Song #3',
                artist: 'Track 3',
                url: 'https://open.spotify.com/embed/track/4Md9beL6rRxjjdhjQdQgIc',
                cover: 'https://images.unsplash.com/photo-1459749411177-042180ce673c?w=300&h=300&fit=crop'
            }
        ];

        function loadAudioPreset(trackNumber) {
            spotifyCurrentTrack = trackNumber - 1;
            const track = spotifyTracks[spotifyCurrentTrack];
            
            // Update UI
            const albumArt = document.getElementById('spotify-album-art');
            const trackTitle = document.getElementById('spotify-track-title');
            const trackArtist = document.getElementById('spotify-track-artist');
            const playerTitle = document.getElementById('player-title');
            const playerArtist = document.getElementById('player-artist');
            const playerArtSmall = document.getElementById('player-art-small');
            
            if (albumArt) albumArt.src = track.cover;
            if (trackTitle) trackTitle.textContent = track.title;
            if (trackArtist) trackArtist.textContent = track.artist;
            if (playerTitle) playerTitle.textContent = track.title;
            if (playerArtist) playerArtist.textContent = track.artist;
            if (playerArtSmall) playerArtSmall.innerHTML = `<img src="${track.cover}" class="w-full h-full object-cover rounded">`;
            
            // Load the track via iframe embed (Spotify requires iframe for playback)
            const spotifyWin = document.getElementById('window-temu-spotify');
            if (spotifyWin) {
                const mainContent = spotifyWin.querySelector('.flex-1.bg-gradient-to-b');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <iframe 
                            src="${track.url}?utm_source=generator" 
                            width="100%" 
                            height="100%" 
                            frameBorder="0" 
                            allowfullscreen="" 
                            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                            loading="lazy"
                            style="border-radius: 12px;"
                            onerror="console.error('Failed to load track ${trackNumber}'); showNotification('Spotify', 'Error loading track. This song may not be available.');"
                        ></iframe>
                    `;
                }
            }
            
            console.log('Loading track:', trackNumber, 'URL:', track.url);
            showNotification('Spotify', `Now playing: ${track.title}`);
        }

        function spotifyTogglePlayback() {
            // Since we're using Spotify embeds, we can't control playback directly
            // The user needs to click play in the embedded player
            showNotification('Spotify', 'Click play in the player above');
        }

        function spotifyNextTrack() {
            spotifyCurrentTrack = (spotifyCurrentTrack + 1) % spotifyTracks.length;
            loadAudioPreset(spotifyCurrentTrack + 1);
        }

        function spotifyPrevTrack() {
            spotifyCurrentTrack = (spotifyCurrentTrack - 1 + spotifyTracks.length) % spotifyTracks.length;
            loadAudioPreset(spotifyCurrentTrack + 1);
        }

        function spotifySeekTrack(event, element) {
            // Seeking not available with Spotify embeds
        }

        function spotifySetVolume(event, element) {
            const rect = element.getBoundingClientRect();
            const percent = ((event.clientX - rect.left) / rect.width) * 100;
            const volBar = document.getElementById('spotify-volume-bar');
            if (volBar) volBar.style.width = percent + '%';
        }

    </script>
</body>
</html>
